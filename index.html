<!DOCTYPE html>
<!--
====================================================================
CONFIGURATION RAPIDE (Ã  modifier en haut du fichier)

- homeHeaderDefaultByLang : texte court dans la banderole AVANT le choix
  (ex. 'Bienvenue' / 'Welcome' / 'VÃ¤lkommen' OU 'Questionnaire' / 'FrÃ¥geformulÃ¤r')
- homeHeaderIntroLinesByLang : 2 lignes dâ€™intro affichÃ©es dans la banderole (accueil)
- availableLangsByForm : langues disponibles par ID de questionnaire (empÃªche "Continuer" si non dispo)
- disabledForms : IDs des questionnaires pas encore prÃªts (seront affichÃ©s "(indisponible)")
- formLabelsByLang : libellÃ©s des questionnaires dans la liste (si votre code ne les dÃ©finit pas dÃ©jÃ )
- introByFormOverrides : texte dâ€™intro (page 2) spÃ©cifique par formulaire et langue (Ã©crase le gÃ©nÃ©rique)
- messagesInterfaceOverrides : petites clÃ©s i18n Ã  surcharger (ex. notAvailableLang, only)
- APP_VERSION_OVERRIDE : pour forcer la version affichÃ©e sans Ã©diter APP.version plus bas (optionnel)

- Il existe deux banques de questions :
    1. questionsBank : version complÃ¨te, utilisÃ©e en routine (DSM, Sommeil, etc.).
    2. questionsBankShort (ou Intro) : version rÃ©duite, utilisÃ©e uniquement pour des tests ou des dÃ©monstrations.
   Le programme charge lâ€™une ou lâ€™autre en fonction du mode choisi (standard vs test).

COMMENT MODIFIER :
- Changez simplement les valeurs dans les objets JS ci-dessous (entre <script>â€¦</script>).
- Laissez les clÃ©s telles quelles (FranÃ§ais/English/Svenska, DSM/SOMMEIL/etc.).

====================================================================
-->
ï»¿<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>html,body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,sans-serif}</style>

<style>
#introText { white-space: pre-line; line-height: 1.9 !important; }
#labelCode { font-weight: 700; }
</style>

<!-- Menu Langue (donne bien id="langSelect") -->


<!-- SÃ©lecteur de voix + test -->

</div>


<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Questionnaire</title>
</head>
<body>

<script>


// === CONFIGURATION Ã€ REMPLIR pour la duree d'acces au programme ===

var validDays = ;// durÃ©e en jours, si champ libre unlimitÃ©, ex = 4, 4 jours,=0 expirÃ©

// === CALCUL DATE EXPIRATION ===
var now = new Date();//stocke date et heure actuelle utilisÃ©es pour date d'expiration
var expireDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + validDays);


// === MESSAGES MULTILINGUES ===
var messages = {
  fr: {
    expired: "âš ï¸ Ce test nâ€™est plus disponible (expirÃ©).",
    warn: "âš ï¸ Attention : ce test sera dÃ©sactivÃ© demain.",
    welcome: "âœ… Ce test est valable jusquâ€™au "
  },
  en: {
    expired: "âš ï¸ This test is no longer available (expired).",
    warn: "âš ï¸ Warning: this test will be disabled tomorrow.",
    welcome: "âœ… This test is valid until "
  },
  sv: {
    expired: "âš ï¸ Detta test Ã¤r inte lÃ¤ngre tillgÃ¤ngligt (utgÃ¥nget).",
    warn: "âš ï¸ Varning: detta test kommer att stÃ¤ngas av i morgon.",
    welcome: "âœ… Detta test Ã¤r giltigt till "
  }
};

// === FORMAT DATE ===
function formatDate(d, lang) {
  var locales = { fr: "fr-FR", en: "en-US", sv: "sv-SE" };
  return d.toLocaleDateString(locales[lang] || "fr-FR", {
    year: 'numeric', month: 'long', day: 'numeric'
  });
}

// === AFFICHAGE EN 3 LANGUES ===
(function(){
  var oneDay = 24 * 60 * 60 * 1000;
  var diffDays = Math.ceil((expireDate - now) / oneDay);

  if (now > expireDate) {
    // ExpirÃ©
    document.write(
      "<h2 style='color:#d00000;text-align:center'>" +
      messages.fr.expired + "<br>" +
      messages.en.expired + "<br>" +
      messages.sv.expired + "</h2>"
    );
    return;
  }

  // Bandeau accueil (valable jusqu'Ã ...)
  var banner =
    "<div style='text-align:center;color:#d00000;font-weight:bold;line-height:1.6;margin:8px 0'>" +
    messages.fr.welcome + formatDate(expireDate, "fr") + "<br>" +
    messages.en.welcome + formatDate(expireDate, "en") + "<br>" +
    messages.sv.welcome + formatDate(expireDate, "sv") +
    "</div>";
  document.write(banner);

  // Bandeau rouge la veille (au lieu d'une popup)
  if (diffDays === 1) {
    var warnBanner =
      "<div style='background:#d00000;color:white;text-align:center;padding:10px;font-weight:bold;line-height:1.6'>" +
      messages.fr.warn + "<br>" +
      messages.en.warn + "<br>" +
      messages.sv.warn +
      "</div>";
    document.write(warnBanner);
  }
})();
</script>






  <!-- ========== CONFIG ACCUEIL & I18N (Ã©diter ici) ========== -->
  <script>
    // Titre court dans la banderole AVANT le choix
    window.homeHeaderDefaultByLang = {
      'FranÃ§ais': 'Questionnaire',
      'English':  'Questionnaire',
      'Svenska':  'FrÃ¥geformulÃ¤r'
    };

    // 2 lignes dâ€™intro dans la banderole (accueil)
    window.homeHeaderIntroLinesByLang = {
      'FranÃ§ais': [
        'Choisissez un questionnaire et une langue pour commencer.',
        'Vos rÃ©ponses sont confidentielles. Prenez votre temps.'
      ],
      'English': [
        'Pick a questionnaire and a language to get started.',
        'Your answers are confidential. Take your time.'
      ],
      'Svenska': [
        'VÃ¤lj formulÃ¤r och sprÃ¥k fÃ¶r att bÃ¶rja.',
        'Dina svar Ã¤r konfidentiella. Ta den tid du behÃ¶ver.'
      ]
    };

    // Langues disponibles par questionnaire (ID = valeurs exactes du <select>)
    window.availableLangsByForm = {
      DSM:       ['FranÃ§ais','English','Svenska'],
      Sommeil:   ['FranÃ§ais','English','Svenska'],
      Psych:     ['FranÃ§ais','English','Svenska'],
      Neurology: ['FranÃ§ais','English','Svenska'],
      MedGle:    ['FranÃ§ais','English','Svenska']};

    // Questionnaires temporairement indisponibles (affiche "(indisponible)")
   window.disabledForms = []; // rien de dÃ©sactivÃ©

   //libellÃ©s
window.formLabelsByLang = {
  'FranÃ§ais': { DSM:'DSM-5', Sommeil:'Sommeil', Psych:'Psych', Neurology:'Neurologie', MedGle:'MÃ©decine gÃ©nÃ©rale' },
  'English' : { DSM:'DSM-5', Sommeil:'Sleep',   Psych:'Psych', Neurology:'Neurology',  MedGle:'General Medicine' },
  'Svenska' : { DSM:'DSM-5', Sommeil:'SÃ¶mn',    Psych:'Psykiatri', Neurology:'Neurologi', MedGle:'AllmÃ¤nmedicin' }
};

 // (facultatif) intros overrides
  window.introByFormOverrides = window.introByFormOverrides || {
    'FranÃ§ais': {}, 'English': {}, 'Svenska': {}
  };

 // Petites clÃ©s i18n
  window.messagesInterfaceOverrides = window.messagesInterfaceOverrides || {
    'FranÃ§ais': { notAvailableLang:'Non disponible dans cette langue', only:'seulement' },
    'English' : { notAvailableLang:'Not available in this language',   only:'only' },
    'Svenska' : { notAvailableLang:'Inte tillgÃ¤ngligt pÃ¥ detta sprÃ¥k', only:'endast' }
  };

  window.APP_VERSION_OVERRIDE = window.APP_VERSION_OVERRIDE || "";

</script>

<script>
    // Intro (page 2) spÃ©cifique par formulaire (facultatif : Ã©crase le texte gÃ©nÃ©rique)
</script>
   

  <!-- ========== /CONFIG ========== -->

  <!-- ========== BANQUE DE QUESTIONS (multi-formulaires) ========== -->
  <script>
    /* Remplacez ces tableaux par vos questions rÃ©elles.
       Laissez les clÃ©s (DSM, SOMMEIL, NEUROLOGIE, PSYCHIATRIE, MEDEG) et les langues. */
    window.QUESTIONNAIRE_BANK = {
      DSM: {
        FranÃ§ais: [
          { section: 1, skipIfNon: true, text: "Avez-vous eu rÃ©cemment des pÃ©riodes de tristesse ? (Si non, passer Ã  la section suivante)" },
          { id:"DSM_FR_Q1", type:"oui-non", texte:"Ces deux derniÃ¨res semaines, vous Ãªtes-vous senti(e) dÃ©primÃ©(e) ?" },
          { id:"DSM_FR_Q2", type:"texte",   texte:"Pouvez-vous prÃ©ciser ?" }
        ],
        English: [
          { section: 1, skipIfNon: true, text: "Have you recently had periods of sadness? (If no, skip to next section)" },
          { id:"DSM_EN_Q1", type:"oui-non", texte:"In the last two weeks, have you felt depressed?" },
          { id:"DSM_EN_Q2", type:"texte",   texte:"Please specify." }
        ],
        Svenska: [
          { section: 1, skipIfNon: true, text: "Har du nyligen haft perioder av nedstÃ¤mdhet? (Om nej, gÃ¥ vidare)" },
          { id:"DSM_SV_Q1", type:"oui-non", texte:"Har du kÃ¤nt dig deprimerad de senaste tvÃ¥ veckorna?" },
          { id:"DSM_SV_Q2", type:"texte",   texte:"FÃ¶rklara gÃ¤rna." }
        ]
      },
      SOMMEIL: {
        FranÃ§ais: [
          { section: 1, skipIfNon: true, text: "Avez-vous des difficultÃ©s dâ€™endormissement ? (Si non, passer Ã  la section suivante)" },
          { id:"SOM_FR_Q1", type:"oui-non", texte:"Avez-vous des difficultÃ©s Ã  vous endormir ?" },
          { id:"SOM_FR_Q2", type:"texte",   texte:"Ã€ quelle frÃ©quence ?" }
        ],
        English: [
          { section: 1, skipIfNon: true, text: "Do you have trouble falling asleep? (If no, skip to next section)" },
          { id:"SOM_EN_Q1", type:"oui-non", texte:"Do you have difficulty falling asleep?" },
          { id:"SOM_EN_Q2", type:"texte",   texte:"How often?" }
        ],
        Svenska: [
          { section: 1, skipIfNon: true, text: "Har du svÃ¥rt att somna? (Om nej, gÃ¥ vidare)" },
          { id:"SOM_SV_Q1", type:"oui-non", texte:"Har du svÃ¥rt att somna?" },
          { id:"SOM_SV_Q2", type:"texte",   texte:"Hur ofta?" }
        ]
      },
      NEUROLOGIE: {
        FranÃ§ais: [
          { section: 1, skipIfNon: true, text: "Avez-vous eu des maux de tÃªte rÃ©cents ? (Si non, section suivante)" },
          { id:"NEURO_FR_Q1", type:"oui-non", texte:"Maux de tÃªte frÃ©quents ?" },
          { id:"NEURO_FR_Q2", type:"texte",   texte:"PrÃ©cisez la frÃ©quence." }
        ],
        English:  [
          { section: 1, skipIfNon: true, text: "Any recent headaches? (If no, next section)" },
          { id:"NEURO_EN_Q1", type:"oui-non", texte:"Frequent headaches?" },
          { id:"NEURO_EN_Q2", type:"texte",   texte:"How often?" }
        ],
        Svenska:  [
          { section: 1, skipIfNon: true, text: "Har du haft huvudvÃ¤rk nyligen? (Om nej, nÃ¤sta avsnitt)" },
          { id:"NEURO_SV_Q1", type:"oui-non", texte:"Ofta huvudvÃ¤rk?" },
          { id:"NEURO_SV_Q2", type:"texte",   texte:"Hur ofta?" }
        ]
      },
      PSYCHIATRIE: {
        FranÃ§ais: [ { section:1, skipIfNon:true, text:"Section psychiatrieâ€¦" } ],
        English:  [ { section:1, skipIfNon:true, text:"Psychiatry sectionâ€¦" } ],
        Svenska:  [ { section:1, skipIfNon:true, text:"Psykiatri avsnittâ€¦" } ]
      },
      MEDEG: {
        FranÃ§ais: [ { section:1, skipIfNon:true, text:"MÃ©decine gÃ©nÃ©raleâ€¦" } ],
        English:  [ { section:1, skipIfNon:true, text:"General medicineâ€¦" } ],
        Svenska:  [ { section:1, skipIfNon:true, text:"AllmÃ¤nmedicinâ€¦" } ]
      }
    };
  </script>
  <!-- ========== /BANQUE DE QUESTIONS ========== -->


  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="pageTitle">Questionnaire</title>

  <style>
    body{
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header, footer{
      background-color: #0056cc;
      color: #fff;
      padding: 1em;
      text-align: center;
    }

    section{
      background-color: #fff;
      margin: 1.5em auto;
      padding: 1.5em;
      border-radius: 8px;
      max-width: 900px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1, h2{
      color: #0056cc;
      margin-top: 0;
    }

    /* Barre de titre compacte */
    #titleBar{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:baseline;
      margin:0;
    }
    #versionNum{ font-weight:normal; opacity:.95; }

    /* Instructions */
    .instructions{
      background-color:#ffffcc;
      color:#000;
      font-size:1em;
      padding:10px;
      border-radius:5px;
      margin-bottom:10px;
    }
    .instructions span{ color:#c00; font-weight:bold; }
    #microStatus{ font-weight:bold; margin-left:10px; color:red; }

    .question-number{ font-weight:bold; margin-bottom:5px; }
    .section-number{ color:#0056cc; font-weight:bold; margin-bottom:10px; }

    textarea, input[type="text"], input[type="number"]{
      width:96%;
      font-size:1em;
      padding:8px;
      margin-top:5px;
      border:1px solid #ccc;
      border-radius:4px;
      min-height:40px;
    }

    button{
      background-color:#0056cc;
      color:#fff;
      border:none;
      padding:10px 18px;
      margin:8px 5px;
      border-radius:4px;
      cursor:pointer;
      font-size:1em;
    }
    button:hover{ background-color:#004bb5; }

    .error{ color:red; margin-top:8px; min-height:20px; font-weight:bold; }

    #progressContainer{ background:#ddd; width:100%; height:8px; margin-top:15px; border-radius:5px; }
    #progressBar{ background:#0056cc; height:8px; width:0%; border-radius:5px; }

    #scoreContainer{ display:none; margin-top:10px; }
    #scoreContainer label{ color:red; font-weight:bold; }

    ul{ list-style:none; padding:0; }
    textarea.editable{ width:95%; min-height:50px; margin-top:5px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px; }

    /* Accueil : selects plus petits et lisibles */
    #menuScreen select{
      width:50%;
      max-width:360px;
      font-size:14px;
      padding:4px 8px;
      height:32px;
      background:#fff;
      color:#000;
      border:1px solid #888;
      box-shadow:none;
      appearance:auto;
    }
    #menuScreen label{
      display:inline-block;
      min-width:140px;
      margin-bottom:4px;
    }
  
    /* >>> AJOUT : rendre le texte du header lisible (blanc sur bandeau bleu) <<< */
    header h1, header #titleBar, header #titleBar span {
      color: #fff !important;
    }

    /* >>> AJOUT : rendre le texte du header lisible (blanc sur bandeau bleu) <<< */
    header h1, header #titleBar, header #titleBar span { color: #fff !important; }

    /* Intro d'accueil (bandeau bleu) */
    .header-intro{
      margin:.25em auto 0;
      max-width:900px;
      font-size:.95em;
      line-height:1.35;
      opacity:.95;
    }
    header .header-intro{ color:#fff; }

    /* Intro un peu plus grande dans la banderole */
    header .header-intro{
      font-size: 1.15em;
      line-height: 1.45;
      font-weight: 500;
      opacity: 1;
    }
</style>
</head>

<body>

  <header>
    <h1 id="titleBar">
      <span id="mainTitle">Questionnaire DSM-5</span>
      â€”
      <span id="versionNum">Version Q10p</span>
    </h1>
    <div id="headerIntro" class="header-intro" aria-live="polite" style="display:none"></div>
  </header>


  <!-- ======================================================
       ACCUEIL / INTRO / QUESTIONNAIRE / RÃ‰SUMÃ‰
       ====================================================== -->
  <section id="menuScreen">
    <h2>SÃ©lectionner Questionnaire et Langue</h2>

    <label for="questionnaireSelect">Questionnaire :</label>
    <select id="questionnaireSelect"></select>
    <br><br>
<!-- â–¼â–¼ TTS: sÃ©lecteur de voix par langue â–¼â–¼ -->
<div id="voiceRow" style="margin-top:10px;">
  <label for="voiceSelect">Voix (selon lâ€™appareil) :</label>
  <select id="voiceSelect" style="width:50%;max-width:360px;height:32px;"></select>
  <button id="testVoiceBtn" type="button" style="margin-left:6px;">Test voix</button>
  <div id="voiceHint" style="font-size:.9em;opacity:.8;margin-top:4px;"></div>
</div>
<!-- â–²â–² TTS: sÃ©lecteur de voix par langue â–²â–² -->


    <label for="langSelect">Langue :</label>
    <select id="langSelect"></select>
    <br><br>
    <div id="menuError" class="error"></div>
    <button id="nextLangBtn">Continuer</button>
  </section>

  <section id="introScreen" style="display:none;">
    <h2>Introduction</h2>

    <p id="introText"></p>

    <label id="labelCode"></label><br>
    <input type="text" id="codeInput" maxlength="4" inputmode="numeric" pattern="[0-9]*" />
    <div id="introErrorMsg" class="error"></div>

    <br>
    <button id="startBtn">Commencer</button>
  </section>

  <section id="main" style="display:none;">
    <div id="instructionBox" class="instructions">
      Au clavier <span>RETOUR</span>, en vocal dire <span>STOP</span>
      <span id="microStatus">ğŸ¤ Micro fermÃ©</span>
    </div>

    <div id="sectionNum" class="section-number"></div>
    <div id="questionNum" class="question-number"></div>

    <div id="questionText"></div>

    <textarea id="answerInput"></textarea>
    <div id="mainErrorMsg" class="error"></div>

    <div id="scoreContainer">
      <label id="scoreLabel">âš ï¸ AprÃ¨s votre rÃ©ponse, entrez un chiffre de 1 Ã  4 : 1=rarement, 2=parfois, 3=souvent, 4=trÃ¨s souvent</label>
      <br>
      <input type="number" id="scoreInput" min="1" max="4" />
      <button id="validateScoreBtn">OK</button>
    </div>

    <div id="progressContainer"><div id="progressBar"></div></div>

    <button id="validerBtn">Valider</button>
    <button id="corrigerBtn">Corriger</button>
    <button id="pauseBtn">Pause</button>
    <button id="voiceBtn" type="button" onclick="(function(){var SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){alert('TaligenkÃ¤nning stÃ¶ds inte i denna webblÃ¤sare.');return;}if(!(window.isSecureContext||location.protocol==='https:'||location.hostname==='localhost')){alert('Mikrofon krÃ¤ver HTTPS (eller localhost) pÃ¥ Android.');return;}if(!window.__rec){window.__rec=new SR();var lang=(window.currentLang==='FranÃ§ais'?'fr-FR':(window.currentLang==='English'?'en-US':'sv-SE'));window.__rec.lang=lang;window.__rec.interimResults=true;window.__rec.continuous=false;window.__rec.maxAlternatives=1;window.__rec.onstart=function(){var b=document.getElementById('voiceBtn');if(b){var on=(window.messagesInterface&&window.currentLang&&window.messagesInterface[window.currentLang]?window.messagesInterface[window.currentLang].microOn:'ğŸ¤ Mikrofon pÃ¥');b.textContent=on;b.classList.add('active');}};window.__rec.onend=function(){var b=document.getElementById('voiceBtn');if(b){var off=(window.messagesInterface&&window.currentLang&&window.messagesInterface[window.currentLang]?window.messagesInterface[window.currentLang].microOff:'ğŸ¤ Mikrofon av');b.textContent=off;b.classList.remove('active');}};window.__rec.onerror=function(e){console.warn('Reco error',e);var b=document.getElementById('voiceBtn');if(b){var off=(window.messagesInterface&&window.currentLang&&window.messagesInterface[window.currentLang]?window.messagesInterface[window.currentLang].microOff:'ğŸ¤ Mikrofon av');b.textContent=off;b.classList.remove('active');}};}var ok=true; try{window.__rec.start();}catch(e){ok=false;}if(!ok && navigator.mediaDevices && navigator.mediaDevices.getUserMedia){navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){try{s.getTracks().forEach(function(t){t.stop();});}catch(_){}}).then(function(){setTimeout(function(){try{window.__rec.start();}catch(_){}} , 0);});}})()">ğŸ™ï¸ Mikrofon</button>
    <button id="ttsToggleBtn" onclick="(function(){var cur=(typeof window.ttsEnabled==='undefined'?true:!!window.ttsEnabled);window.ttsEnabled=!cur;try{ttsEnabled=window.ttsEnabled;}catch(_){ }if(!window.ttsEnabled && window.speechSynthesis && speechSynthesis.cancel){try{speechSynthesis.cancel();}catch(_){}}try{if(typeof updateTTSBtn==='function')updateTTSBtn();}catch(_){ }})()">RÃ¶st</button>
  </section>

  <section id="summary" style="display:none;">
    <h2 id="summaryTitle">Sammanfattning och korrigering</h2>
    <p><strong id="summaryCodeLabel">FormulÃ¤rkod :</strong> <span id="resumeCode"></span></p>
    <ul id="answersList"></ul>
    <label id="globalCommentLabel" for="globalComment">Kommentarer</label>

    <textarea id="globalComment" placeholder="Votre commentaire globalâ€¦"></textarea>
    <br>
    <button id="pdfBtn">Exportera PDF</button>
    <button id="copyBtn">Kopiera</button>
    <button id="closeBtn">SlutfÃ¶r</button>
    <!-- CODICENT: send button + status (ensured) -->
    <button id="sendToCodicentBtn">Skicka fÃ¶r analys</button>
    <div id="codicentStatus" style="display:none; margin-top:8px; font-weight:600;"></div>
  </section>

  <footer style="text-align:center;font-size:.85em;color:#ddd;margin-top:2em;">
    <p>Â© 2025 SwedSleep - vers 10p</p>
  </footer>


  <!-- ======================================================
       SCRIPT â€“ CONFIG, DONNÃ‰ES, FONCTIONS
       ====================================================== -->
  <script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CONFIG : titre dynamique (nom + version)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const APP = {
    nom: "Questionnaire DSM-5",
    version: "Version Q10p"};

  function majTitrePage(nom = APP.nom, version = APP.version){
    try{
      document.getElementById('pageTitle').textContent = version ? (nom + " - " + version) : nom;
    }catch(_){}
  }

  function updateHeaderBar(){
    try{
      document.getElementById("mainTitle").textContent  = APP.nom;
      document.getElementById("versionNum").textContent = APP.version;
    }catch(_){}
    majTitrePage();
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DONNÃ‰ES : formulaires, intros, messages, questions
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const disabledForms = ["Sommeil","Psych","Neurology","MedGle"];

  const introByForm = {
    "FranÃ§ais": {
      unavailable: "indisponible",
      DSM: "Ce questionnaire est anonyme.\nJe vais vous poser des questions se rapportant aux 2 derniers mois.\nCes questions sont regroupÃ©es en sections.\nComptez environ 15 min. Vous pouvez faire une pause.\nEn cas dâ€™erreur, vous pouvez corriger.\nRÃ©pondez DE PREFERENCE sur le clavier mais vous pouvez aussi utiliser le micro.\nParlez alors lentement et distinctement, terminez vos rÃ©ponses en disant STOP ou VALIDER.\nÃ€ la fin, vous pourrez corriger vos rÃ©ponses, ajouter un commentaire, copier vos rÃ©ponses ou les enregistrer en PDF grÃ¢ce aux boutons prÃ©vus Ã  cet effet.\nSi vous ne voulez pas entendre les questions pressez la touche VOCAL",
      Sommeil: "Questionnaire Sommeil (FR)â€¦",
      Psych: "Questionnaire Psych (FR)â€¦",
      Neurology: "Questionnaire Neurologie (FR)â€¦",
      MedGle: "Questionnaire MÃ©decine GÃ©nÃ©rale (FR)â€¦",
      comments: "Kommentarer"},
    "English": {
      unavailable: "unavailable",
      DSM: "This form screens DSM-5 related symptoms. Answer freely. You can pause anytime.",
      Sommeil: "Sleep questionnaire (EN)â€¦",
      Psych: "Psych questionnaire (EN)â€¦",
      Neurology: "Neurology questionnaire (EN)â€¦",
      MedGle: "General Practice questionnaire (EN)â€¦",
      comments: "Comments"},
    "Svenska": {
      unavailable: "otillgÃ¤nglig",
      DSM:"Detta frÃ¥geformulÃ¤r Ã¤r anonymt.\nJag kommer att stÃ¤lla frÃ¥gor som rÃ¶r de senaste 2 mÃ¥naderna.\nDessa frÃ¥gor Ã¤r grupperade i avsnitt.\nDet tar cirka 15 minuter. Du kan ta en paus.\nOm du gÃ¶r ett misstag kan du korrigera det.\nSvara HELST pÃ¥ tangentbordet men du kan ocksÃ¥ anvÃ¤nda mikrofonen.\nTala sedan lÃ¥ngsamt och tydligt, avsluta dina svar genom att sÃ¤ga SLUT.\nI slutet kan du korrigera dina svar, lÃ¤gga till en kommentar, kopiera dina svar eller spara dem som en PDF med hjÃ¤lp av de knappar som finns.\nOm du inte vill hÃ¶ra frÃ¥gorna, tryck pÃ¥ RÃ–ST-knappen",
      Sommeil: "SÃ¶mnformulÃ¤r (SV)â€¦",
      Psych: "PsykologiformulÃ¤r (SV)â€¦",
      Neurology: "NeurologiformulÃ¤r (SV)â€¦",
      MedGle: "AllmÃ¤nmedicin formulÃ¤r (SV)â€¦",
      comments: "Kommentarer"},
      sendForAnalysis: "Skicka fÃ¶r analys",
      codicentSuccessPrefix: "EnvoyÃ© Ã  Codicent ! ID : ",
      codicentErrorPrefix: "Erreur dâ€™envoi Ã  Codicent : ",
      noTokenMsg: "Aucun jeton ?token=â€¦ trouvÃ© dans lâ€™URL.",
      sendForAnalysis: "Skicka fÃ¶r analys"
      };

  let config = {
    nomQuestionnaire: "Questionnaire DSM-5",
    version: "v Q10p",
    couleursBande: "#ffffcc",
    langues: ["FranÃ§ais","English","Svenska"],
    
 // Temps de reponse avant de passer a la prochaine question - "minDelayDefault" doit etre plus petit que que "tempsMaxReponse")

    tempsBaseReponse: 1200,// delai de base avant de passer Ã  la question suivante, ici defaut 1200 =1,2 sec
    tempsParCaractere: 50,//delai supplemntaire par caractÃ¨re saisi dans la rÃ©ponse (50 ms/caractere)
    tempsMaxReponse: 4000, // plafond maximum (ici 4000= 4 sec)

// <<< nouveaux planchers >>>
  minDelayDefault: 1200, // 1.2 s
  minDelayNo:      1000, // 1.0 s pour "non/no/nej"
  minDelaySkip:    1500  // 1.5 s si saut de section
  };

  // QUESTIONS â€“ liste complÃ¨te (sections 1 â†’ 23)
  let questions = [
  
{ section: 1, text: "Hur gammal Ã¤r du?" },

{ text: "Ã„r du man, kvinna eller annat?" },

{ text: "Vad har du fÃ¶r yrke?" },

{ section: 2, text: "Finns det kÃ¤nda medicinska tidigare sjukdomar? Om ja, specificera." },

{ text: "Tar du fÃ¶r nÃ¤rvarande nÃ¥gra lÃ¤kemedelsbehandlingar? Om ja, ange vilka, inklusive receptfria lÃ¤kemedel och kosttillskott." },

{ section: 3, text: "KÃ¤nner du nervositet, Ã¥ngest eller Ã¶verdriven spÃ¤nning?" },

{ text: "Har du en tendens att oroa dig Ã¶verdrivet fÃ¶r olika saker eller har svÃ¥rt att kontrollera din oro?" },

{ text: "Har du svÃ¥rt att koncentrera dig, t.ex. nÃ¤r du lÃ¤ser eller tittar pÃ¥ tv?" },

{ text: "KÃ¤nner du dig rastlÃ¶s eller har svÃ¥rt att sitta stilla?" },

{ text: "Har du fÃ¶rÃ¤ndrad aptit, sÃ¥som minskad eller Ã¶kad aptit?" },

{ text: "KÃ¤nner du misslyckande eller att du har svikit dig sjÃ¤lv eller andra?" },

{ section: 4, text: "Saknar du intresse eller glÃ¤dje i sÃ¥dant du tidigare tyckte om?" },

{ text: "KÃ¤nner du sorg, nedstÃ¤mdhet eller hopplÃ¶shet?" },

{ text: "KÃ¤nner du dig trÃ¶tt eller har du brist pÃ¥ energi?" },

{ section: 5, text: "Upprepar du vissa handlingar, som att tvÃ¤tta hÃ¤nderna, rÃ¤kna, kontrollera eller ordna saker? (Om nej, gÃ¥ vidare till nÃ¤sta avsnitt)" },

{ text: "UtfÃ¶rs dessa beteenden som svar pÃ¥ tvÃ¥ngstankar eller rÃ¤dsla?" },

{ text: "Upptar dessa tankar eller beteenden mer Ã¤n en timme per dag eller stÃ¶r de din vardag avsevÃ¤rt?" },

{ section: 6, text: "Blir du lÃ¤tt irriterad eller arg?" },

 ];

  // Indices de questions Ã  Ã©chelle (1â€“5) : marquage "scale"
  let notables = [5,6,7,8,9,10,11,12,13,14,15,16,17,19,20,21,22,23,25,27,28,31,33,34,35,36,38,41,42,43,44,45,47,48,49,50];
  notables.forEach(i => { if (questions[i]) questions[i].type = "scale"; });


  // Sections Ã  skip (si la 1re Q rÃ©pond "non" etc.)
  const sectionsAvecSkip = [5];


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MESSAGES UI (FR/EN/SV)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let messagesInterface = {
    "FranÃ§ais": {
      btnPDF:"Exportera PDF", btnCopy:"Kopiera", btnClose:"SlutfÃ¶r",
      menuTitle:"SÃ©lectionner Questionnaire et Langue",
      labelQuestionnaire:"Questionnaire :",
      labelLangue:"Langue :",
      continuer:"Continuer",
      intro:"Ce questionnaire est anonyme et vous aide Ã  Ã©valuer votre bien-Ãªtre mental.",
      codeLabel:"Entrez maintenant un code de votre choix Ã  4 chiffres en le tapant sur le clavier",
      start:"Commencer",
      pause:"Pause", reprendre:"Reprendre",
      microOff:"ğŸ¤ Micro fermÃ©", microOn:"ğŸ¤ Micro actif",
      summaryTitle:"Sammanfattning och korrigering", codeLabelSummary:"FormulÃ¤rkod :",
      errorCode:"Veuillez entrer un code Ã  5 chiffres valide.",
      errorScale:"Entrez un chiffre de 1 Ã  5 : 1=jamais, 2=rarement, 3=parfois, 4=souvent, 5=trÃ¨s souvent",
      ttsOn:"Vocal", ttsOff:"Silence",
      btnPDF:"Exportera PDF", btnCopy:"Kopiera", btnClose:"SlutfÃ¶r",
      promptFilename:"Entrez un nom de fichier (.txt)",
      defaultFilename:"RÃ©ponses_Questionnaire_",
      valider:"Valider", corriger:"Corriger",
      alertOption:"Option non installÃ©e, reprenez la 1Ã¨re option",
      alertSaved:"Vos rÃ©ponses ont Ã©tÃ© enregistrÃ©es.",
      sectionLabel: "Section",
     questionLabel: "Question",
     introTitle: "Introduction",
      programme:"Programme",
      language:"Langue",
      globalCommentPlacehoder: "votre commentaire global",
      alertRewrite:"RÃ©Ã©crivez votre rÃ©ponse"},

    "English": {
      btnPDF:"Export PDF", btnCopy:"Copy", btnClose:"Finish",
      menuTitle:"Select Questionnaire and Language",
      labelQuestionnaire:"Questionnaire:", labelLangue:"Language:",
      continuer:"Continue", intro:"This questionnaire is anonymous.",
      codeLabel:"Enter your 4-digit code:", start:"Start",
      pause:"Pause", reprendre:"Resume",
      microOff:"ğŸ¤ Micro off", microOn:"ğŸ¤ Micro on",
      summaryTitle:"Summary and correction", codeLabelSummary:"Questionnaire code:",
      errorCode:"Please enter a valid 5-digit code.",
      errorScale:"After your answer, enter a number 1â€“5:1=never, 2=rarely, 3=sometimes, 4=often, 5=very often",
      ttsOn:"Voice", ttsOff:"Silence",
      btnPDF:"Export PDF", btnCopy:"Copy", btnClose:"Finish",
      promptFilename:"Enter a filename (.txt)",
      defaultFilename:"Questionnaire_Answers_",
      valider:"Validate", corriger:"Correct",
      alertOption:"Option not installed, please select the first option.",
      alertSaved:"Your responses have been saved.",
      sectionLabel: "Section",
      questionLabel: "Question",
      introTitle: "Introduction",
      programme:"Program",
      language:"Language",
      globalCommentPlaceholder: "Your overall commentâ€¦",
      alertRewrite:"Rewrite your answer"},

    "Svenska": {
      btnPDF:"Exportera PDF", btnCopy:"Kopiera", btnClose:"Avsluta",
      menuTitle:"VÃ¤lj formulÃ¤r och sprÃ¥k",
      labelQuestionnaire:"FormulÃ¤r:", labelLangue:"SprÃ¥k:",
      continuer:"FortsÃ¤tt", intro:"Detta formulÃ¤r Ã¤r anonymt.",
      codeLabel:"Ange din fyrsiffriga kod:", start:"Starta",
      pause:"Paus", reprendre:"Ã…teruppta",
      microOff:"ğŸ¤ Mikrofon av", microOn:"ğŸ¤ Mikrofon pÃ¥",
      summaryTitle:"Sammanfattning och korrigering", codeLabelSummary:"FormulÃ¤rkod:",
      errorCode:"Ange en giltig femsiffrig kod.",
      errorScale:"Efter ditt svar, ange en siffra: 1=aldrig, 2=sÃ¤llan, 3=ibland, 4=ofta, 5=mycket ofta",
      ttsOn:"RÃ¶st", ttsOff:"Tyst",
      btnPDF:"Exportera PDF", btnCopy:"Kopiera", btnClose:"Avsluta",
      promptFilename:"Ange ett filnamn (.txt)",
      defaultFilename:"FormulÃ¤r_Svar_",
      valider:"BekrÃ¤fta", corriger:"Korrigera",
      alertOption:"Alternativet Ã¤r inte installerat, vÃ¤lj det fÃ¶rsta alternativet.",
      alertSaved:"Dina svar har sparats." ,
      sectionLabel: "Sektion",
      questionLabel: "FrÃ¥ga",
      introTitle: "Introduktion",
      programme:"Program",
      language:"SprÃ¥k",
      globalCommentPlaceholder: "Din allmÃ¤nna kommentarâ€¦",
      alertRewrite:"Skriv om ditt svar"}
};  // <= fin de messagesInterface
 window.messagesInterface = messagesInterface; // â† on lâ€™attache Ã  window

// Texte d'instructions par langue (bandeau jaune)
window.instructionTextByLang = {
  'FranÃ§ais': 'Au clavier <span>RETOUR</span>, en vocal dire <span>STOP</span>',
  'English' : 'On keyboard press <span>ENTER</span>, by voice say <span>STOP</span>',
  'Svenska' : 'PÃ¥ tangentbordet tryck <span>RETUR</span>, med rÃ¶st sÃ¤g <span>SLUT</span>'
};

function refreshInstructionBanner(){
  const ib = document.getElementById('instructionBox');
  if (!ib) return;
  const m = (window.messagesInterface && window.messagesInterface[currentLang]) || window.messagesInterface['FranÃ§ais'];
  const instr = (window.instructionTextByLang && window.instructionTextByLang[currentLang]) || window.instructionTextByLang['FranÃ§ais'];
  const microText = (typeof listening !== 'undefined' && listening) ? m.microOn : m.microOff;
  ib.innerHTML = instr + ' <span id="microStatus">' + microText + '</span>';
}

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Ã‰TAT GLOBAL
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let userCode = "", currentQuestion = 0;
  let answers = [];
  let paused = false, recognition = null, listening = false;
  let isValidating = false;
  let ttsEnabled = true;
  let currentLang = "Svenska";
  let justCorrected = false;
  const isMobile = /Android|iPhone|iPad|iPod|SamsungBrowser/i.test(navigator.userAgent);
  const mapChiffres = { "un":"1","une":"1","deux":"2","trois":"3","quatre":"4","one":"1","two":"2","three":"3","four":"4","ett":"1","tvÃ¥":"2","tva":"2","tre":"3","fyra":"4" };


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PRÃ‰PARATION DES SECTIONS / SKIP
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function preparerQuestions(arr, sectionsSkip){
    let courant = null;
    arr.forEach((q, idx) => {
      if (typeof q.section !== "undefined") courant = q.section;
      else if (courant !== null)          q.section = courant;
      else                                q.section = 0;

      if (sectionsSkip.includes(q.section)){
        if (idx === 0 || arr[idx-1].section !== q.section) q.skipIfNon = true;
      }
    });
  }
  preparerQuestions(questions, [5]);


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // OUTILS UI
  function showNoSpeech(){
    const txt = (messagesInterface && messagesInterface[currentLang] && messagesInterface[currentLang].noSpeech) || "ğŸ¤ Pas de voix dÃ©tectÃ©e";
    const ms  = document.getElementById("microStatus");
    if (ms){ ms.textContent = txt; ms.style.color = "orange"; }
    const err = document.getElementById("mainErrorMsg") || document.getElementById("menuError");
    if (err) err.textContent = txt;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function jouerBipErreur(){
    try{
      const c=new (window.AudioContext||window.webkitAudioContext)();
      const o=c.createOscillator(); const g=c.createGain();
      o.type="sine"; o.frequency.value=440; g.gain.value=.1;
      o.connect(g); g.connect(c.destination);
      o.start(); o.stop(c.currentTime+.25);
    }catch(_){}
  }

  function updateProgress(){
    document.getElementById("progressBar").style.width = ((currentQuestion/questions.length)*100)+"%";
  }

  function updateTTSBtn(){ const b = document.getElementById('ttsToggleBtn'); if(!b) return; const enabled = (typeof window.ttsEnabled!=='undefined')? !!window.ttsEnabled : (typeof ttsEnabled!=='undefined'? !!ttsEnabled : true); b.textContent = enabled ? messagesInterface[currentLang].ttsOn : messagesInterface[currentLang].ttsOff; try{ b.setAttribute('aria-pressed', enabled?'true':'false'); }catch(_){} }

  function updateQuestionnaireLabels(){
    try{
      const sel=document.getElementById('questionnaireSelect'); if(!sel) return;
      const map = {
        'FranÃ§ais': { DSM:'DSM-5', Sommeil:'Sommeil', Psych:'Psych', Neurology:'Neurologie', MedGle:'Med Gle' },
        'English' : { DSM:'DSM-5', Sommeil:'Sleep',   Psych:'Psych', Neurology:'Neurology', MedGle:'GP' },
        'Svenska' : { DSM:'DSM-5', Sommeil:'SÃ¶mn',    Psych:'Psych', Neurology:'Neurologi', MedGle:'AllmÃ¤nt Med' }
      }[currentLang] || {};
      for (let i=0;i<sel.options.length;i++){
        const o=sel.options[i]; const v=(o.value||'').trim();
        if(map[v]) o.text = map[v] + (disabledForms.includes(v) ? " (" + messagesInterface[currentLang].unavailable + ")" : "");
      }
    }catch(_){}
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // AJOUT : mettre Ã  jour tous les libellÃ©s selon la langue (UpdateInterfaceLangue)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateInterfaceLang() {
document.documentElement.setAttribute(
  "lang",
  ({ Svenska: "sv", FranÃ§ais: "fr", English: "en" }[currentLang]) || "en"
);

    const m = (messagesInterface && messagesInterface[currentLang]) || messagesInterface["FranÃ§ais"];
    refreshInstructionBanner();
// ... Ã  la fin de updateInterfaceLang()
try { onUILanguageChanged(); } catch(_){}

    // Accueil
     // Titre de la page d'intro (h2)
const introH2 = document.querySelector('#introScreen h2');
if (introH2) introH2.textContent = m.introTitle || 'Introduction';
    const h2 = document.querySelector('#menuScreen h2'); if (h2) h2.textContent = m.menuTitle;
    const labQ = document.querySelector('label[for="questionnaireSelect"]'); if (labQ) labQ.textContent = m.labelQuestionnaire;
    const labL = document.querySelector('label[for="langSelect"]'); if (labL) labL.textContent = m.labelLangue;
    const nextBtn = document.getElementById("nextLangBtn"); if (nextBtn) nextBtn.textContent = m.continuer;

    // Intro
    const lblCode = document.getElementById("labelCode"); if (lblCode) lblCode.textContent = m.codeLabel;
    const startBtn = document.getElementById("startBtn"); if (startBtn) startBtn.textContent = m.start;
    const introP = document.getElementById("introText"); if (introP && introP.textContent.trim()==="") introP.textContent = m.intro;

    // Main
    const validerBtn = document.getElementById("validerBtn"); if (validerBtn) validerBtn.textContent = m.valider;
    const corrigerBtn = document.getElementById("corrigerBtn"); if (corrigerBtn) corrigerBtn.textContent = m.corriger;
    const pauseBtn = document.getElementById("pauseBtn"); if (pauseBtn) pauseBtn.textContent = m.pause;

    // TTS + micro
    updateTTSBtn();
    const voiceBtn = document.getElementById("voiceBtn");
    if (voiceBtn) voiceBtn.textContent = (typeof listening!=="undefined" && listening) ? m.microOn : m.microOff;

    // fin
    const globalComment = document.getElementById("globalComment");
    if (globalComment) globalComment.placeholder = m.globalCommentPlaceholder || "";


    // fin
    const sendBtn = document.getElementById("sendToCodicentBtn");
    if (sendBtn) sendBtn.textContent = m.sendForAnalysis || "Send for analysis";

    // Bouton d'envoi (i18n)
    localizeSendButton();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}


    // Titre
    updateHeaderBar();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}

  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // TTS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ===== TTS â€” bloc unique (PC / Samsung) =====
// Une seule dÃ©claration dans tout le fichier :



var TTS_STORE_KEY = "ttsVoiceNameByLangCode";
var ttsVoiceNameByLang = {};

// 1) Langue courante -> code normalisÃ© via window.currentLang ("Svenska"/"FranÃ§ais"/"English")
function getCurrentLangCode(){
  var txt = (window.currentLang || "").toLowerCase();
  if (txt.includes("sv")) return "sv-SE";
  if (txt.includes("en")) return "en-US";
  if (txt.includes("fr")) return "fr-FR";
  return "fr-FR";
}

// 2) Store
(function(){
  try{ ttsVoiceNameByLang = JSON.parse(localStorage.getItem(TTS_STORE_KEY) || "{}"); }
  catch(_){ ttsVoiceNameByLang = {}; }
})();
function tts_saveStore(){
  try{ localStorage.setItem(TTS_STORE_KEY, JSON.stringify(ttsVoiceNameByLang)); }catch(_){}
}

// 5) RÃ©cup voix choisie
function tts_getSelectedVoice(){
  var sel = document.getElementById("voiceSelect");
  var name = sel && sel.value;
  return name ? (__voices||[]).find(v => v.name === name) || null : null;
}

// 6) Charger/rafraÃ®chir les voix
function tts_loadVoices(){
  try{ __voices = synth ? (synth.getVoices() || []) : []; }catch(_){ __voices = []; }
  tts_populateVoiceSelect();
}
if (typeof speechSynthesis !== "undefined"){
  
  setTimeout(tts_loadVoices, 0);
  setTimeout(tts_loadVoices, 600); // Android/Chrome charge parfois en retard
}

// 7) Brancher lâ€™UI + synchroniser currentLang avec le menu langue (id="langSelect")
document.addEventListener("DOMContentLoaded", function(){
  // sÃ©curise currentLang au dÃ©marrage
  window.currentLang = window.currentLang || "FranÃ§ais";

  var langSelect = document.getElementById("langSelect"); // <-- donne cet id Ã  ton menu Langue
  if (langSelect){
    // init
    window.currentLang = langSelect.value || langSelect.options[langSelect.selectedIndex]?.text || window.currentLang;
    onUILanguageChanged();

    // changement
    langSelect.addEventListener("change", function(){
      window.currentLang = langSelect.value || langSelect.options[langSelect.selectedIndex]?.text || "FranÃ§ais";
      onUILanguageChanged();
    });
  }

  var sel = document.getElementById("voiceSelect");
  if (sel){
    sel.addEventListener("change", function(){
      var key = getCurrentLangCode().substring(0,2).toUpperCase();
      ttsVoiceNameByLang[key] = sel.value || "";
      tts_saveStore();
    });
  }

  var testBtn = document.getElementById("testVoiceBtn");
  if (testBtn){
    testBtn.addEventListener("click", function(){
      var code = getCurrentLangCode();
      var sample = code.startsWith("sv") ? "Det hÃ¤r Ã¤r ett rÃ¶sttest."
                 : code.startsWith("en") ? "This is a voice test."
                 : "Ceci est un test de voix.";
      tts_testSpeak(sample);
    });
  }

  // force un premier chargement
  tts_loadVoices();
});

// 8) Test voix (dÃ©bloque Android/Chrome)
function tts_testSpeak(text){
  if (!synth || !text) return;
  try{
    var u = new SpeechSynthesisUtterance(text);
    u.lang = getCurrentLangCode();
    var v = tts_getSelectedVoice(); if (v) u.voice = v;
    u.rate = 1.0; u.pitch = 1.0;
    synth.cancel(); synth.speak(u);
  }catch(_){}
}

// 9) Ã€ appeler quand ta logique change window.currentLang
function onUILanguageChanged(){
  try { tts_populateVoiceSelect(); } catch(_){}
}








  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RECONNAISSANCE VOCALE (HTTPS, pas dâ€™auto-start)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setRecognitionLang(){
    if(!recognition) return;
    recognition.lang=(currentLang==="English")?"en-US":(currentLang==="Svenska")?"sv-SE":"fr-FR";
  }

  function initRecognition(){
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const ms = document.getElementById("microStatus");

    if(!window.SpeechRecognition){
      if(ms) ms.textContent = (currentLang==="English")?"ğŸ¤ Not supported":"ğŸ¤ Non supportÃ©";
      return;
    }
    if(!window.isSecureContext && location.hostname!=="localhost"){
      if(ms) ms.textContent=(currentLang==="English")?"ğŸ¤ HTTPS required":"ğŸ¤ HTTPS requis";
      return;
    }

    recognition = new window.SpeechRecognition();
    setRecognitionLang();
    recognition.continuous=true; recognition.interimResults=false;

    recognition.onstart = ()=>{
      listening=true;
      document.getElementById("microStatus").textContent=messagesInterface[currentLang].microOn;
      document.getElementById("voiceBtn").textContent=messagesInterface[currentLang].microOn;
      document.getElementById("microStatus").style.color="green";
    };
    recognition.onend   = ()=>{
      listening=false;
      document.getElementById("microStatus").textContent=messagesInterface[currentLang].microOff;
      document.getElementById("voiceBtn").textContent=messagesInterface[currentLang].microOff;
      document.getElementById("microStatus").style.color="red";
    };
    recognition.onerror = (e)=>{
      listening=false;
      const err = e && e.error;
      if (err === "no-speech"){
        showNoSpeech();
      } else {
        const ms = document.getElementById("microStatus");
        if (ms){
          let msg = "ğŸ¤ Erreur";
          if (err==="not-allowed"||err==="service-not-allowed") msg = messagesInterface[currentLang].permDenied || "ğŸ¤ BehÃ¶righet nekad (activez le micro)";
          else if (err==="audio-capture") msg = messagesInterface[currentLang].audioCapture || "ğŸ¤ Micro non dÃ©tectÃ©";
          else if (err==="no-speech")     msg = messagesInterface[currentLang].noSpeech || "ğŸ¤ Pas de voix dÃ©tectÃ©e";
          ms.textContent = msg;
        }
      }
      document.getElementById("voiceBtn").textContent=messagesInterface[currentLang].microOff;
    };
    recognition.onresult=(e)=>{
      try{
        let base = e.results[e.results.length-1];
        if (!base || !base[0] || !base[0].transcript){ showNoSpeech(); return; }
        let txt=String(base[0].transcript).toLowerCase().trim();
        txt=txt.replace(/\b(un|une|deux|trois|quatre|one|two|three|four|ett|tvÃ¥|tva|tre|fyra)\b/g,m=>mapChiffres[m]||m);
        if(txt.includes("stop")||txt.includes("slut")){
          txt=txt.replace(/(?:stop|slut)/gi,"").trim();
          document.getElementById("answerInput").value=txt;
          validateAnswer();
        }else{
          document.getElementById("answerInput").value=txt;
        }
      }catch(_){}
    };
  }

  /* (disabled by patch) original voiceBtn onclick was here */


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // AFFICHAGE DE LA QUESTION COURANTE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showQuestion(){
  // couper le micro si actif
   
if (recognition && listening){
    try { recognition.abort(); } catch(_) { try { recognition.stop(); } catch(_){} }
    listening = false;
  }

  // SÃ©curitÃ© : si plus de questions â†’ rÃ©sumÃ©
  if (!Array.isArray(questions) || currentQuestion >= questions.length){
    if (typeof showSummary === "function") showSummary();
    return;
  }

  const q = questions[currentQuestion] || {};
  const m = (messagesInterface && messagesInterface[currentLang]) || messagesInterface["FranÃ§ais"];

  const sectionEl = document.getElementById("sectionNum");
  if (sectionEl) sectionEl.textContent = q.section ? `${m.sectionLabel} ${q.section}` : "";

  const qNumEl = document.getElementById("questionNum");
  if (qNumEl) qNumEl.textContent = `${m.questionLabel} ${(currentQuestion+1)}/${questions.length}`;

  const qTextEl = document.getElementById("questionText");
  if (qTextEl) qTextEl.innerHTML = q.text || "";

  const errEl = document.getElementById("mainErrorMsg");
  if (errEl) errEl.textContent = "";

  const scoreBox = document.getElementById("scoreContainer");
  if (scoreBox) scoreBox.style.display = "none";

  const f = document.getElementById("answerInput");
  if (f){ f.value = ""; setTimeout(()=>f.focus(), 100); }

  updateProgress();

  // ğŸ” Banderole (RETUR/AVSLUTA / micro on/off) selon la langue
  if (typeof refreshInstructionBanner === "function") refreshInstructionBanner();

  // TTS
  if (typeof lireTexte === "function") lireTexte(q.text || "");
}

    // âŒ Pas dâ€™auto-dÃ©marrage micro (Ã©vite re-prompts permission)
    // setTimeout(()=>{ if(recognition && !paused && !isMobile){ recognition.start(); listening=true; }},1200);


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VALIDATION (attend correction + Ã©chelle + skip)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function validateAnswer(extraScore=null){
    if (paused){ isValidating=false; return; }

    { const _f=document.getElementById("answerInput"); const _r=((_f&&_f.value)||"").trim();
      if (justCorrected && (!_r && !extraScore)){ isValidating=false; return; } }

    if (isValidating) return; isValidating=true;
    if (typeof questions[currentQuestion]==="undefined"){ isValidating=false; return; }

    const f=document.getElementById("answerInput"); let r=(f.value||"").trim();
    if (justCorrected && (!r && !extraScore)){ isValidating=false; return; }
    justCorrected=false;

    if (!r && !extraScore){
      isValidating=false;
      document.getElementById("mainErrorMsg").textContent="âš ï¸ Skriv ett svar eller diktera SLUT";
      setTimeout(()=>document.getElementById("mainErrorMsg").textContent="",2000);
      return;
    }

    if (questions[currentQuestion].type==="scale"){
      const lowerResp=r.toLowerCase();

      // Skip section si 1re question et "non/no/nej"
      if (questions[currentQuestion].skipIfNon && (/(^|\b)(non|no|nej|n)(\b|$)/i).test(lowerResp)){
        answers[currentQuestion]=r||"(sans rÃ©ponse)";
        const sectionActuelle=questions[currentQuestion].section;
        let next=currentQuestion+1;
        while(next<questions.length && questions[next].section===sectionActuelle) next++;
const tSkip = Math.max(
  config.tempsBaseReponse + r.length*config.tempsParCaractere,
  config.minDelaySkip
);
        setTimeout(()=>{ if(justCorrected){ isValidating=false; return; } currentQuestion=next; isValidating=false; if(currentQuestion<questions.length) showQuestion(); else showSummary(); }, tSkip);
        return;
      }

      // "non" simple -> avancer
      if ((/(^|\b)(non|no|nej|n)(\b|$)/i).test(lowerResp)){
        answers[currentQuestion]=r||"(sans rÃ©ponse)";
        let t=Math.min(config.tempsBaseReponse + r.length*config.tempsParCaractere, config.tempsMaxReponse);
       
     // Temps d'attente apres RETOUR avant de passer a la question suivante pour donner le temps de corriger ici 2000 = 2 sec 
	//t=Math.max(t,2000);
      t = Math.max(t, config.minDelayNo);

        setTimeout(()=>{ if(justCorrected){ isValidating=false; return; } currentQuestion++; isValidating=false; if(currentQuestion<questions.length) showQuestion(); else showSummary(); }, t);
        return;
      }

      // Demander score si absent
      let score=extraScore;
      if(!score){
        const sc=document.getElementById("scoreContainer"); sc.style.display="block";
        document.getElementById("scoreLabel").innerHTML='<span style="color:red;font-weight:bold;">'+messagesInterface[currentLang].errorScale+'</span>';
        document.getElementById("mainErrorMsg").textContent="";
        const scoreInput=document.getElementById("scoreInput");
        scoreInput.min="1"; scoreInput.max="4"; scoreInput.value="";
        setTimeout(()=>scoreInput.focus(),100);
        const handler=(e)=>{ if(e.key==="Enter"){ e.preventDefault(); document.getElementById("validateScoreBtn").click(); scoreInput.removeEventListener("keypress",handler);} };
        scoreInput.addEventListener("keypress",handler);
        if (recognition && listening){
          recognition.onresult=(e)=>{
            let txt=e.results[e.results.length-1][0].transcript.toLowerCase().trim();
            txt=txt.replace(/\b(un|une|deux|trois|quatre|one|two|three|four|ett|tvÃ¥|tva|tre|fyra)\b/g,m=>mapChiffres[m]||m);
            if (/(?:stop|slut)/.test(txt)){
              let chiffre=txt.replace(/(?:stop|slut)/gi,"").trim();
              if(chiffre && !isNaN(chiffre) && chiffre>=1 && chiffre<=4){ document.getElementById("scoreInput").value=chiffre; document.getElementById("validateScoreBtn").click(); }
            }
          };
        }
        const btn=document.getElementById("validateScoreBtn");
        btn.replaceWith(btn.cloneNode(true)); // reset listeners
        document.getElementById("validateScoreBtn").onclick=()=>{
          const entered=document.getElementById("scoreInput").value;
//     Erreur si notable <1 ou > 5
          if(!entered || isNaN(entered) || entered<1 || entered>5){
            jouerBipErreur();
            try{ document.getElementById("scoreInput").style.borderColor="red"; setTimeout(()=>{ document.getElementById("scoreInput").style.borderColor=""; },600);}catch(_){}
            return;
          }
          document.getElementById("scoreContainer").style.display="none";
          validateAnswer(entered);
        };
        isValidating=false; return;
      }

      r = r ? (r+" - "+score) : score;
    }

    answers[currentQuestion]=r||"(sans rÃ©ponse)";
    let t=Math.min(config.tempsBaseReponse + r.length*config.tempsParCaractere, config.tempsMaxReponse);
t = Math.max(t, config.minDelayDefault);
    setTimeout(()=>{ if(justCorrected){ isValidating=false; return; } currentQuestion++; isValidating=false; if(currentQuestion<questions.length) showQuestion(); else showSummary(); }, t);
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // BOUTONS (valider, corriger, pause, export)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById("validerBtn").onclick = validateAnswer;

  document.getElementById("answerInput").addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); validateAnswer(); }
  });

  document.getElementById("corrigerBtn").onclick = ()=>{
    const f=document.getElementById("answerInput"); f.value="";
    const sc=document.getElementById("scoreContainer"); if(sc){ sc.style.display="none"; document.getElementById("scoreInput").value=""; }
    if (recognition && listening){ try{ recognition.abort(); }catch(_){ recognition.stop(); } listening=false; }
    justCorrected=true; setTimeout(()=>f.focus(),100);
    const err=document.getElementById("mainErrorMsg"); err.textContent=(messagesInterface[currentLang] && messagesInterface[currentLang].alertRewrite) || "RÃ©Ã©crivez votre rÃ©ponse"; setTimeout(()=>err.textContent="",4000);
  };

  document.getElementById("pauseBtn").onclick = ()=>{
    if(!paused){
      localStorage.setItem("QSM_"+userCode, JSON.stringify({answers,currentQuestion}));
      document.getElementById("pauseBtn").textContent = messagesInterface[currentLang].reprendre;
      paused=true; if(recognition && listening){ try{ recognition.abort(); }catch(_){ recognition.stop(); } listening=false; }
    }else{
      paused=false; document.getElementById("pauseBtn").textContent = messagesInterface[currentLang].pause;
      const saved=localStorage.getItem("QSM_"+userCode);
      if(saved){ const d=JSON.parse(saved); answers=d.answers||[]; currentQuestion=d.currentQuestion||0; }
      showQuestion();
    }
  };

  function showSummary(){
    document.getElementById("main").style.display="none";
    document.getElementById("summary").style.display="block";
    document.getElementById("resumeCode").textContent=userCode;
    const ul=document.getElementById("answersList"); ul.innerHTML="";
    questions.forEach((q,i)=>{
      const li=document.createElement("li");
      li.innerHTML=`<b>${q.text}</b><br><textarea class='editable' onchange='answers[${i}]=this.value'>${answers[i]||''}</textarea>`;
      ul.appendChild(li);
    });
    lireTexte(messagesInterface[currentLang].summaryTitle);
  
    
    // i18n right after summary appears
    setSendBtnLabel();
    setTimeout(setSendBtnLabel, 50);
    setTimeout(setSendBtnLabel, 200);
// Localize Codicent send button when summary becomes visible
    try {
      const m = (window.messagesInterface && window.messagesInterface[currentLang]) || {};
      const sendBtn = document.getElementById("sendToCodicentBtn");
      if (sendBtn) sendBtn.textContent = m.sendForAnalysis || "Send for analysis";
    } catch(_) {}
}

  document.getElementById("pdfBtn").onclick=()=>{
    let txt="Code: "+userCode+"\n";
    questions.forEach((q,i)=>{ txt+=`${i+1}. ${q.text}\nRÃ©ponse: ${answers[i]||''}\n\n`; });
    const w=window.open('','_blank'); if(w){ w.document.write('<pre>'+txt+'</pre>'); w.print(); }
  };

// terminer: demande de nom de fichier et sauvegarde

  document.getElementById("copyBtn").onclick=()=>{
    let txt="Code: "+userCode+"\n";
    questions.forEach((q,i)=>{ txt+=`${i+1}. ${q.text}: ${answers[i]||''}\n`; });
    const blob=new Blob([txt],{type:'text/plain'});
    const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download="RÃ©ponses_Questionnaire_"+userCode+".txt"; link.click();
  };
// -----------------------
// AVSLUTA
document.getElementById("closeBtn").onclick = () => {
  const filename = prompt(
    messagesInterface[currentLang].promptFilename,
    (messagesInterface[currentLang].defaultFilename || "FormulÃ¤r_Svar_") + userCode + ".txt"
  );
  if (!filename) return;

  // 1) Construire le contenu
  let txt = "Code: " + userCode + "\n";
  questions.forEach((q, i) => {
    txt += `${i + 1}. ${q.text}\nRÃ©ponse: ${answers[i] || ""}\n\n`;
  });

  // 2) TÃ©lÃ©charger le .txt
  const blob = new Blob([txt], { type: "text/plain" });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);

  // 3) Ã‰cran final + ENTER pour fermer (SV/FR/EN)

const finalLang   = (["Svenska","FranÃ§ais","English"].includes(currentLang)) ? currentLang : "English";
const finalFolder = { Svenska: "HÃ¤mtade filer", FranÃ§ais: "TÃ©lÃ©chargements", English: "Downloads" }[finalLang];
const finalTexts  = {
  Svenska: {
    screen: `Tack! Dina svar har sparats i mappen ${finalFolder}.<br><br>Du kan nu stÃ¤nga fÃ¶nstret.`,
    hint:   'Tryck RETUR fÃ¶r att stÃ¤nga fliken.',
    block:  'Automatisk stÃ¤ngning blockerad. Tryck Ctrl+W (Cmd+W pÃ¥ Mac) eller Alt+F4.'
  },
  FranÃ§ais: {
    screen: `Merci ! Vos rÃ©ponses ont Ã©tÃ© enregistrÃ©es dans le dossier ${finalFolder}.<br><br>Vous pouvez maintenant fermer la fenÃªtre.`,
    hint:   'Appuyez sur ENTRÃ‰E pour fermer lâ€™onglet.',
    block:  'Fermeture auto bloquÃ©e. Appuyez sur Ctrl+W (Cmd+W sur Mac) ou Alt+F4.'
  },
  English: {
    screen: `Thanks! Your answers have been saved in the ${finalFolder} folder.<br><br>You can now close this window.`,
    hint:   'Press ENTER to close the tab.',
    block:  'Auto-close blocked. Press Ctrl+W (Cmd+W on Mac) or Alt+F4.'
  }
}[finalLang];

// Rendu de lâ€™Ã©cran final
document.body.innerHTML = `
  <div id="finalScreen" style="text-align:center; margin-top:50px; font-size:1.5em;">
    ${finalTexts.screen}
    <div id="closeHint" style="margin-top:16px; font-size:1rem; opacity:.8;">${finalTexts.hint}</div>
  </div>
`;

// DÃ©tection â€œouvert par scriptâ€ ou via lanceur (optionnel: ?spawned=1)
const spawned = (() => {
  try { return new URLSearchParams(location.search).get('spawned') === '1'; } catch(_) { return false; }
})();

// Tentative de fermeture
function attemptCloseOnce(){
  try {
    // Cas OK: fenÃªtre enfant ouverte par script (ou marquÃ©e spawned)
    if ((window.opener && !window.opener.closed) || spawned) { window.close(); return true; }
    // Cas navigation interne: revenir en arriÃ¨re
    if (history.length > 1) { history.back(); return true; }
    // Dernier essai (souvent bloquÃ©)
    window.open('', '_self'); window.close();
  } catch(_) {}
  return false;
}

// ENTER / NUMPAD-ENTER â€” feedback immÃ©diat si bloquÃ©
function onCloseKey(e){
  const k = e.key;
  if (k !== 'Enter' && k !== 'NumpadEnter') return;
  e.preventDefault();

  const ok = attemptCloseOnce();
  if (!ok) {
    const hint = document.getElementById('closeHint');
    if (hint) {
      hint.textContent = finalTexts.block;
      hint.style.opacity = '1';
      hint.style.fontWeight = '700';
    }
  }
}
document.addEventListener('keydown', onCloseKey, { capture: true });

// Click sur lâ€™Ã©cran final: mÃªme logique (fermer ou afficher lâ€™instruction)
document.getElementById('finalScreen').addEventListener('click', () => {
  const ok = attemptCloseOnce();
  if (!ok) {
    const hint = document.getElementById('closeHint');
    if (hint) {
      hint.textContent = finalTexts.block;
      hint.style.opacity = '1';
      hint.style.fontWeight = '700';
    }
  }
}, { once: false });
 
}; // <-- FIN de closeBtn.onclick

// --------------------------

  /* Ensure Codicent button exists */
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var summary = document.getElementById('summary');
      if (!summary) return;
      var btn = document.getElementById('sendToCodicentBtn');
      var pdfBtn = document.getElementById('pdfBtn');
      if (!btn && pdfBtn){
        btn = document.createElement('button');
        btn.id = 'sendToCodicentBtn';
        // Default label; will be localized by updateInterfaceLang if present
        var m = (window.messagesInterface && window.messagesInterface[window.currentLang]) || {};
        btn.textContent = (m && m.sendForAnalysis) || 'Send for analysis';
        pdfBtn.insertAdjacentElement('afterend', btn);
      }
      var status = document.getElementById('codicentStatus');
      if (!status){
        status = document.createElement('div');
        status.id = 'codicentStatus';
        status.style.display = 'none';
        status.style.marginTop = '8px';
        status.style.fontWeight = '600';
        (btn || pdfBtn).insertAdjacentElement('afterend', status);
      }
    }catch(e){ console.warn('Codicent button ensure failed:', e); }
  });

  
  // === Helper: localize the Codicent send button according to currentLang ===
  function localizeSendButton(){
    try{
      var m = (window.messagesInterface && window.messagesInterface[currentLang]) || {};
      var sb = document.getElementById('sendToCodicentBtn');
      if (sb) sb.textContent = (m && m.sendForAnalysis) || 'Send for analysis';
    }catch(_){}
  }

  
  // Strong i18n setter for the Codicent send button (with fallbacks)
  function setSendBtnLabel(){
    try{
      var L = window.currentLang || 'FranÃ§ais';
      var m = (window.messagesInterface && window.messagesInterface[L]) || {};
      var b = document.getElementById('sendToCodicentBtn');
      if (!b) return;
      var fallback = (L==='Svenska') ? 'Skicka fÃ¶r analys' : (L==='FranÃ§ais' ? 'Envoyer pour analyse' : 'Send for analysis');
      b.textContent = m.sendForAnalysis || fallback;
    }catch(_){}
  }

  // === CODICENT â€“ Token, prÃ©paration du contenu et envoi ===
  // RÃ©cupÃ¨re le token depuis l'URL (?token=...)
  function getCodicentToken(){
    try{
      const p = new URLSearchParams(location.search);
      return p.get('token') || null;
    }catch(_){ return null; }
  }

  // Construit le message Ã  envoyer (Q/R + code + commentaire)
  function prepareMessageContent(){
    let content = `Form Data:

`;
    const formCode = document.getElementById('codeInput')?.value || userCode || "";
    if (formCode) content += `Code: ${formCode}

`;
    (questions || []).forEach((q, i) => {
      content += `${i+1}. ${q.text || ""}
`;
      content += `Answer: ${answers[i] || ""}

`;
    });
    const globalComment = document.getElementById('globalComment')?.value?.trim();
    if (globalComment) content += `Comments: ${globalComment}
`;
    // Tag projet (Ã  adapter si nÃ©cessaire)
    return `@swedsleep_demo #profile ${content}`;
  }

  // Gestion du clic sur le bouton "Envoyer pour analyse"
  document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('sendToCodicentBtn');
    const statusDiv = document.getElementById('codicentStatus');
    if (!btn) return;
    btn.addEventListener('click', async function(){
      try{
        const token = getCodicentToken();
        if (!token){
          if (statusDiv){ statusDiv.style.display='block'; statusDiv.style.color='red'; statusDiv.textContent = (messagesInterface?.[currentLang]?.noTokenMsg) || 'No ?token parameter found in URL.'; }
          return;
        }
        // Init Codicent
        try { window.Codicent && window.Codicent.init({ token, maxConnectionAttempts: 3 }); } catch(e){ /* ignore init errors here */ }

        const message = prepareMessageContent();
        const id = await (window.Codicent && window.Codicent.postMessage ? window.Codicent.postMessage({ message }) : Promise.reject(new Error('CodicentJS not loaded')));

        if (statusDiv){ statusDiv.style.display='block'; statusDiv.style.color='green'; statusDiv.textContent = (messagesInterface?.[currentLang]?.codicentSuccessPrefix || 'Sent to Codicent: ') + id; }
      }catch(e){
        if (statusDiv){ statusDiv.style.display='block'; statusDiv.style.color='red'; statusDiv.textContent = (messagesInterface?.[currentLang]?.codicentErrorPrefix || 'Error: ') + (e?.message || e); }
      }
      // Auto-hide after a few seconds
      if (statusDiv){ setTimeout(()=>{ statusDiv.style.display='none'; }, 8000); }
    });

      // Relocalize send button on language change
      try{
        var lSel = document.getElementById('langSelect');
        if (lSel){
          lSel.addEventListener('change', function(){
            var m2 = (window.messagesInterface && window.messagesInterface[window.currentLang]) || {};
            var sb = document.getElementById('sendToCodicentBtn');
            if (sb) sb.textContent = (m2 && m2.sendForAnalysis) || 'Send for analysis';
          });
        }
      }catch(_){}
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NAVIGATION + INIT SÃ›RE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startQuestionnaire(){
    const selectedQ=document.getElementById("questionnaireSelect").value;
    if (Array.isArray(disabledForms) && disabledForms.includes(selectedQ)){
      document.getElementById("menuError").textContent = messagesInterface[currentLang].alertOption;
      try{ jouerBipErreur(); }catch(_){}
      alert(messagesInterface[currentLang].alertOption); return;
    }
    userCode=(document.getElementById("codeInput").value||"").trim();
    if (userCode.length!==4 || isNaN(userCode)){
      document.getElementById("introErrorMsg").textContent = messagesInterface[currentLang].errorCode;
      jouerBipErreur(); return;
    }
    answers=[]; currentQuestion=0; localStorage.removeItem("QSM_"+userCode);
    document.getElementById("introScreen").style.display="none";
    document.getElementById("main").style.display="block";
    showQuestion();
    refreshInstructionBanner();
  }

  document.addEventListener("DOMContentLoaded", () => {
    try{ setSendBtnLabel(); }catch(_){ }
    /* Localize send button on DOMContentLoaded */
    try{ const m0=(window.messagesInterface&&window.messagesInterface[currentLang])||{}; const sb0=document.getElementById("sendToCodicentBtn"); if (sb0) sb0.textContent=m0.sendForAnalysis||"Send for analysis"; }catch(_){}
    // Bouton d'envoi (i18n)
    localizeSendButton();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}


    // Titre
    updateHeaderBar();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}


    // Remplir QUESTIONNAIRES
    const qSel = document.getElementById("questionnaireSelect");
    if (qSel){
      qSel.innerHTML =
        '<option value="DSM">DSM-5</option>'+
        '<option value="Sommeil">Sommeil</option>'+
        '<option value="Psych">Psych</option>'+
        '<option value="Neurology">Neurologie</option>'+
        '<option value="MedGle">Med Gle</option>';
      for(let i=0;i<qSel.options.length;i++){ const o=qSel.options[i]; if(disabledForms.includes(o.value)){ o.text = o.text + " (" + messagesInterface[currentLang].unavailable + ")"; } }
      qSel.onchange = function(){
        const val=this.value;
        if(disabledForms.includes(val)){
          const el=document.getElementById("menuError"); if(el) el.textContent = messagesInterface[currentLang].alertOption;
          try{ jouerBipErreur(); }catch(_){}
        }else{
          const el=document.getElementById("menuError"); if(el) el.textContent="";
        }
      };
    }

    // Remplir LANGUES
    const lSel = document.getElementById("langSelect");
    if (lSel){
      lSel.innerHTML =
        '<option value="FranÃ§ais">FranÃ§ais</option>'+
        '<option value="English">English</option>'+
        '<option value="Svenska" selected>Svenska</option>';
      currentLang = lSel.value || "FranÃ§ais";
      lSel.onchange = function(){
        try{ setSendBtnLabel(); }catch(_){ }
        currentLang=this.value;
        updateInterfaceLang();
        updateQuestionnaireLabels();
      };
    }

    // LibellÃ©s init
    updateInterfaceLang();
    updateQuestionnaireLabels();
    updateTTSBtn();

    // CONTINUER -> INTRO
    const nextBtn = document.getElementById("nextLangBtn");
    if (nextBtn){
      nextBtn.onclick = function(){
        const selectedQ = (qSel && qSel.value) || "DSM";
        const allowed = (window.availableLangsByForm && window.availableLangsByForm[selectedQ]) || [];
     if (!allowed.includes(currentLang)) {
    const el = document.getElementById("menuError");
    
    // Message en suÃ©dois, comme demandÃ©
    const seulement = (window.messagesInterfaceOverrides && window.messagesInterfaceOverrides['Svenska'] && window.messagesInterfaceOverrides['Svenska'].only) || 'endast';
    el.textContent = "Ej tillgÃ¤nglig pÃ¥ detta sprÃ¥k (" + seulement + ": " + allowed.join(", ") + ")";
    try{ jouerBipErreur && jouerBipErreur(); }catch(_){}
    return; // NE PAS passer Ã  la page
} 
        if (disabledForms.includes(selectedQ)){
          const el=document.getElementById("menuError"); if(el) el.textContent = messagesInterface[currentLang].alertOption;
          try{ jouerBipErreur(); }catch(_){}
          alert(messagesInterface[currentLang].alertOption);
          return;
        }
        const label = qSel ? qSel.options[qSel.selectedIndex].text.replace(" (indisponible)","") : "DSM-5";
        const headerWord = (window.homeHeaderDefaultByLang &&        window.homeHeaderDefaultByLang[currentLang]) || 'Questionnaire';
       APP.nom = `${headerWord} ${label}`;   
        updateHeaderBar();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}


        const intro = (introByForm[currentLang] && introByForm[currentLang][selectedQ]) ? introByForm[currentLang][selectedQ] : messagesInterface[currentLang].intro;
        const introText = document.getElementById("introText"); if (introText) introText.textContent = intro; introText.style.whiteSpace="pre-line"; introText.style.lineHeight="1.9";
        document.getElementById("menuScreen").style.display="none";
        document.getElementById("introScreen").style.display="block";
        setTimeout(()=>document.getElementById("codeInput").focus(),100);
      };
    }

    // DÃ‰MARRER
    const startBtn = document.getElementById("startBtn");
    if (startBtn){
      startBtn.onclick = startQuestionnaire;
      document.getElementById("codeInput").addEventListener("keypress",e=>{ if(e.key==="Enter"){ e.preventDefault(); startQuestionnaire(); } });
    }
  });
  </script>


  <!-- ======================================================
       AJOUTS FINAUX â€“ TTS toggle + Micro sticky/auto-restart + Android/HTTPS
       ====================================================== -->
  <script>
  (function(){
    // Variables globales (sÃ©curisÃ©es si dÃ©jÃ  dÃ©finies)
    if (typeof window.recognition === "undefined") window.recognition = null;
    if (typeof window.listening   === "undefined") window.listening   = false;
    if (typeof window.currentLang === "undefined") window.currentLang = "Svenska";
    if (typeof window.ttsEnabled  === "undefined") window.ttsEnabled  = true;

    // Helper libellÃ©s (Ã©vite les crash si messagesInterface absent)
    function M(key, fallback){
      try { return (messagesInterface && messagesInterface[currentLang] && messagesInterface[currentLang][key]) || fallback; }
      catch(_){ return fallback; }
    }
    document.addEventListener("DOMContentLoaded", function(){
      var ttsBtn = document.getElementById("ttsToggleBtn");
      if (!ttsBtn) return;
      function updateTTSBtn(){ ttsBtn.textContent = ttsEnabled ? M('ttsOn','Vocal') : M('ttsOff','Silence'); }
      updateTTSBtn();
      ttsBtn.addEventListener("click", function(){
        ttsEnabled = !ttsEnabled;
        try { speechSynthesis.cancel(); } catch(_){}
        updateTTSBtn();
      });
    });

    // === Micro sticky / auto-restart ===
    var micSticky = false;
    var manuallyStopping = false;
    var restartTimer = null;

    // Lang reco
    if (typeof window.setRecognitionLang !== "function"){
      window.setRecognitionLang = function(){
        if(!recognition) return;
        recognition.lang = (currentLang==="English") ? "en-US"
                        : (currentLang==="Svenska") ? "sv-SE"
                        : "fr-FR";
      };
    }

    // Init/override reco (handlers robustes)
    window.initRecognition = function(){
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      var ms = document.getElementById("microStatus");

      if(!window.SpeechRecognition){
        if(ms) ms.textContent = (currentLang==="English") ? "ğŸ¤ Not supported on this device" : "ğŸ¤ Non supportÃ© sur cet appareil";
        return;
      }

      var isFile = location.protocol === "file:";
      if(!window.isSecureContext && location.hostname!=="localhost" && !isFile){
        if(ms) ms.textContent = (currentLang==="English") ? "ğŸ¤ HTTPS required" : "ğŸ¤ HTTPS requis";
        return;
      }

      recognition = new window.SpeechRecognition();
      setRecognitionLang();
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onstart = function(){
        listening = true;
        var ms = document.getElementById("microStatus");
        if (ms){ ms.textContent = M('microOn','Micro ouvert'); ms.style.color = "green"; }
        var btn = document.getElementById("voiceBtn");
        if (btn) btn.textContent = M('microOn','Micro ouvert');
      };

      recognition.onend = function(){
        listening = false;
        var ms = document.getElementById("microStatus");
        if (ms){ ms.textContent = M('microOff','Micro fermÃ©'); ms.style.color = "red"; }
        var btn = document.getElementById("voiceBtn");
        if (btn) btn.textContent = M('microOff','Micro fermÃ©');

        if (micSticky && !manuallyStopping && !document.hidden){
          clearTimeout(restartTimer);
          restartTimer = setTimeout(function(){
            try{ recognition.start(); listening = true; if(btn) btn.textContent = M('microOn','Micro ouvert'); }catch(_){}
          }, 300);
        }
        manuallyStopping = false;
      };

      recognition.onerror = function(e){
        listening = false;
        var err = e && e.error;
        if (err !== "aborted"){
          var ms = document.getElementById("microStatus");
          if (ms){
            var msg = "ğŸ¤ Erreur";
            if (err==="not-allowed"||err==="service-not-allowed") msg = (currentLang==="English")?"ğŸ¤ Permission denied (allow mic)":"ğŸ¤ BehÃ¶righet nekad (activez le micro)";
            else if (err==="audio-capture") msg = (currentLang==="English")?"ğŸ¤ Microphone not found":"ğŸ¤ Micro non dÃ©tectÃ©";
            else if (err==="no-speech")     msg = (currentLang==="English")?"ğŸ¤ No speech detected":"ğŸ¤ Pas de voix dÃ©tectÃ©e";
            ms.textContent = msg;
          }
        }
        if (micSticky && !manuallyStopping && err!=="not-allowed" && err!=="service-not-allowed" && !document.hidden){
          clearTimeout(restartTimer);
          restartTimer = setTimeout(function(){
            try{ recognition.start(); listening = true; var btn=document.getElementById("voiceBtn"); if(btn) btn.textContent = M('microOn','Micro ouvert'); }catch(_){}
          }, 500);
        }
        manuallyStopping = false;
      };

      // onresult : on garde le tien si dÃ©jÃ  dÃ©fini ; sinon, on met une version neutre
      if (typeof recognition.onresult !== "function"){
        recognition.onresult = function(e){
          try{
            var r = e.results[e.results.length-1][0].transcript;
            var txt = (r||"").toLowerCase().trim();
            var a = document.getElementById("answerInput");
            if (a) a.value = txt;
          }catch(_){}
        };
      }
    };

    // Helpers dÃ©marrage/arrÃªt (gÃ¨rent sticky + UI + erreurs visibles)
    window.startMic = function(){
      if(!recognition) initRecognition();
      if(!recognition) return;
      try{ speechSynthesis.cancel(); }catch(_){}
      clearTimeout(restartTimer);
      setRecognitionLang();

      micSticky = true;
      var btn = document.getElementById("voiceBtn");
      var ms  = document.getElementById("microStatus");
      if (btn) btn.textContent = M('microOn','Micro ouvert');
      if (ms){ ms.textContent = M('microOn','Micro ouvert'); ms.style.color="green"; }

      try{
        recognition.start();
        listening = true;
      }catch(err){
        listening = false;
        micSticky = false;
        if (btn) btn.textContent = M('microOff','Micro fermÃ©');
        if (ms)  ms.textContent  = "ğŸ¤ Erreur start: " + ((err && (err.name||err.message)) || "inconnue");
      }
    };

    window.stopMic = function(opts){
      opts = opts || {};
      var manual = (typeof opts.manual==="boolean") ? opts.manual : true;
      if(!recognition) return;
      manuallyStopping = manual;
      if (manual) micSticky = false;
      clearTimeout(restartTimer);
      try{ recognition.abort(); }catch(_){ try{ recognition.stop(); }catch(_){ } }
      listening = false;
      var btn = document.getElementById("voiceBtn");
      var ms  = document.getElementById("microStatus");
      if (btn) btn.textContent = M('microOff','Micro fermÃ©');
      if (ms){ ms.textContent = M('microOff','Micro fermÃ©'); ms.style.color="red"; }
    };

    // Bouton MICRO (remplace les handlers existants si besoin)
    document.addEventListener("DOMContentLoaded", function(){
      var btn = document.getElementById("voiceBtn");
      var ms  = document.getElementById("microStatus");
      if (!btn) return;
      btn.onclick = function(){
        var isAndroid = /Android/i.test(navigator.userAgent);
        var isSecure  = window.isSecureContext || location.protocol === "https:" || location.hostname === "localhost";

        if (listening || micSticky){
          stopMic({manual:true});
          return;
        }
        if (isAndroid && !isSecure){
          if (ms) ms.textContent = "ğŸ¤ Android exige HTTPS pour le micro";
          return;
        }
        // prÃ©-permission uniquement Android
        if (isAndroid && navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
          navigator.mediaDevices.getUserMedia({ audio:true })
            .then(function(s){ s.getTracks().forEach(function(t){t.stop();}); startMic(); })
            .catch(function(){ if (ms) ms.textContent = M('permDenied','ğŸ¤ BehÃ¶righet nekad (activez le micro)'); });
        } else {
          startMic();
        }
      };
    });

    // VisibilitÃ© onglet : stop temporaire / relance
    document.addEventListener("visibilitychange", function(){
      if (document.hidden && listening){
        stopMic({manual:false});
      } else if (!document.hidden && micSticky && !listening){
        startMic();
      }
    });
  })();
  </script>


<!-- === BEGIN: Unavailable label fix (handles (undefined)/language) === -->
<script>
(function(){
  function t(key, fallback){
    try { return (window.messagesInterface && window.messagesInterface[window.currentLang] && window.messagesInterface[window.currentLang][key]) ?? fallback ?? key; }
    catch(_){ return fallback ?? key; }
  }
  function normalizeLang(v){
    const s = String(v||'').toLowerCase();
    if (s.includes('english') || s === 'en') return 'English';
    if (s.includes('svensk') || s.includes('svenska') || s === 'sv') return 'Svenska';
    return 'FranÃ§ais';
  }
  function fixUnavailable(){
    const qsel = document.getElementById('questionnaireSelect');
    if (!qsel) return;
    const word = t('unavailable',
      (window.currentLang==='Svenska') ? 'otillgÃ¤nglig' :
      (window.currentLang==='English') ? 'unavailable'  :
      'indisponible'
    );
    Array.prototype.slice.call(qsel.options).forEach(o=>{
      if (!o || typeof o.text !== 'string') return;
      // replace any (undefined|indisponible|unavailable|otillgÃ¤nglig) at end
      o.text = o.text.replace(/\s*\((?:undefined|indisponible|unavailable|otillgÃ¤nglig)\)\s*$/i, ` (${word})`);
    });
  }
  // Hook language changes if present
  document.addEventListener('DOMContentLoaded', function(){
    const langSel = document.getElementById('langSelect');
    if (langSel){
      langSel.addEventListener('change', function(){
        window.currentLang = normalizeLang(langSel.value);
        try{ fixUnavailable(); }catch(_){}
      });
    }
    try{ fixUnavailable(); }catch(_){}
  });
  // Patch updateQuestionnaireLabels to always fix after it runs
  (function(){
    const orig = window.updateQuestionnaireLabels;
    window.updateQuestionnaireLabels = function(){
      if (typeof orig === 'function'){ try{ orig.apply(this, arguments); }catch(_){ } }
      try{ fixUnavailable(); }catch(_){}
    };
  })();
})();
</script>
<!-- === END: Unavailable label fix === -->


<script>
(function(){
  function renderHomeIntroMinimal(){
    var box = document.getElementById('headerIntro');
    if (!box) return;
    var L = window.currentLang || 'FranÃ§ais';
    var lines = {
      'FranÃ§ais':[
        "Choisissez un questionnaire et une langue pour commencer.",
        "Vos rÃ©ponses sont confidentielles. Prenez votre temps."
      ],
      'English':[
        "Pick a questionnaire and a language to get started.",
        "Your answers are confidential. Take your time."
      ],
      'Svenska':[
        "VÃ¤lj formulÃ¤r och sprÃ¥k fÃ¶r att bÃ¶rja.",
        "Dina svar Ã¤r konfidentiella. Ta den tid du behÃ¶ver."
      ]
    }[L] || ["Choisissez un questionnaire et une langue pour commencer."];
    box.innerHTML = lines.join('<br>');
    box.style.display = 'block';
  }
  document.addEventListener('DOMContentLoaded', function(){
    try{ renderHomeIntroMinimal(); }catch(e){}
  });
})();
</script>


<!-- HEADER d'accueil : lit la CONFIG + i18n + contrÃ´le langue dispo -->

  <!-- ========== CHARGEUR & NOTABLES ========== -->
  <script>
    function getQuestionsFor(formId, lang){
      var bank = window.QUESTIONNAIRE_BANK || {};
      var form = bank[formId] || {};
      if (form[lang] && form[lang].length) return form[lang].slice();
      if (form["FranÃ§ais"] && form["FranÃ§ais"].length) return form["FranÃ§ais"].slice();
      var langs = Object.keys(form);
      for (var i=0;i<langs.length;i++){
        var L = langs[i];
        if (Array.isArray(form[L]) && form[L].length) return form[L].slice();
      }
      return [];
    }

    // Liste dâ€™index notables par formulaire (adaptez Ã  vos tableaux)
    const NOTABLES_BY_FORM = {
      DSM:         [5,6,7,8,9,10],
      SOMMEIL:     [3,4,5,6],
      NEUROLOGIE:  [2,3,7],
      PSYCHIATRIE: [1,5,6],
      MEDEG:       [4,8]
    };

    function applyNotables(formId, questions){
      var list = (NOTABLES_BY_FORM && NOTABLES_BY_FORM[formId]) || [];
      for (var i=0;i<list.length;i++){
        var idx = list[i];
        if (questions[idx]) questions[idx].type = "scale";
      }
    }
  </script>
  <!-- ========== /CHARGEUR & NOTABLES ========== -->

<script id="homeHeader_i18n">
(function(){
  function setHomeHeaderTitle(){
    var title = document.getElementById('mainTitle');
    if (!title) return;
    var L = window.currentLang || 'FranÃ§ais';
    var map = (window.homeHeaderDefaultByLang && typeof window.homeHeaderDefaultByLang === 'object')
      ? window.homeHeaderDefaultByLang
      : { 'FranÃ§ais':'Questionnaire', 'English':'Questionnaire', 'Svenska':'FrÃ¥geformulÃ¤r' };
    title.textContent = map[L] || map['FranÃ§ais'];
  }

  function renderHomeIntro(){
    var box = document.getElementById('headerIntro');
    if (!box) return;
    var L = window.currentLang || 'FranÃ§ais';
    var map = (window.homeHeaderIntroLinesByLang && typeof window.homeHeaderIntroLinesByLang === 'object')
      ? window.homeHeaderIntroLinesByLang
      : {
          'FranÃ§ais':[
            'Choisissez un questionnaire et une langue pour commencer.',
            'Vos rÃ©ponses sont confidentielles. Prenez votre temps.'
          ],
          'English':[
            'Pick a questionnaire and a language to get started.',
            'Your answers are confidential. Take your time.'
          ],
          'Svenska':[
            'VÃ¤lj formulÃ¤r och sprÃ¥k fÃ¶r att bÃ¶rja.',
            'Dina svar Ã¤r konfidentiella. Ta den tid du behÃ¶ver.'
          ]
        };
    var lines = map[L] || map['FranÃ§ais'];
    box.innerHTML = (lines||[]).join('<br>');
    box.style.display = 'block';
  }

  function notAvailMessage(selLang, onlyLangs){
    var mi = (window.messagesInterface && messagesInterface[selLang]) || {};
    var prefix = mi.notAvailableLang
      || (selLang==='English' ? 'Not available in this language'
          : selLang==='Svenska' ? 'Inte tillgÃ¤ngligt pÃ¥ detta sprÃ¥k'
          : 'Non disponible dans cette langue');
    var onlyWord = mi.only
      || (selLang==='English' ? 'only' : selLang==='Svenska' ? 'endast' : 'seulement');
    var abbr = { 'FranÃ§ais':'Fr', 'Svenska':'Su', 'English':'Ang' };
    var ab = (onlyLangs||[]).map(function(L){ return abbr[L] || L; }).join('/');
    return prefix + ' â€” ' + onlyWord + ': ' + ab;
  }

  document.addEventListener('DOMContentLoaded', function(){
    var lSel = document.getElementById('langSelect');
    var qSel = document.getElementById('questionnaireSelect');
    var btn  = document.getElementById('nextLangBtn');
    var err  = document.getElementById('menuError');

    if (lSel && lSel.value) window.currentLang = lSel.value;

    setHomeHeaderTitle();
    renderHomeIntro();

    if (lSel){
      lSel.addEventListener('change', function(){
        window.currentLang = lSel.value || 'FranÃ§ais';
        setHomeHeaderTitle();
        renderHomeIntro();
      });
    }

    // disponibilitÃ© par questionnaire (utilise la CONFIG si fournie)
    window.availableLangsByForm = window.availableLangsByForm || { DSM:['FranÃ§ais'] };

    if (btn && qSel){
      var oldHandler = btn.onclick;
      btn.onclick = function(){
        var formId = (qSel.value||'').trim();
        var lang   = window.currentLang || (lSel && lSel.value) || 'FranÃ§ais';
        var okList = (window.availableLangsByForm && window.availableLangsByForm[formId]) || ['FranÃ§ais'];

        if (okList.indexOf(lang) === -1){
          if (err){ err.textContent = notAvailMessage(lang, okList); }
          try{ if (window.jouerBipErreur) jouerBipErreur(); }catch(_){}
          return;
        }
        try{ var hi=document.getElementById('headerIntro'); if(hi) hi.style.display='none'; }catch(_){}
        if (typeof oldHandler === 'function') return oldHandler.call(this);
      };
    }
  });
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  // APP.version override (optionnel)
  if (window.APP_VERSION_OVERRIDE && typeof window.APP_VERSION_OVERRIDE === 'string' && window.APP_VERSION_OVERRIDE.trim() !== ''){
    try{
      if (window.APP){ APP.version = window.APP_VERSION_OVERRIDE; }
      if (typeof updateHeaderBar === 'function'){ updateHeaderBar();
  // Force Swedish label if active language is Svenska
  try {
    var sbf = document.getElementById('sendToCodicentBtn');
    if (sbf && currentLang === 'Svenska') {
      sbf.textContent = "Skicka fÃ¶r analys";
    }
  } catch(_){}
 }
    }catch(_){}
  }

  // introByForm overrides (merge propriÃ©tÃ© Ã  propriÃ©tÃ©)
  try{
    if (window.introByFormOverrides && window.introByForm){
      Object.keys(window.introByFormOverrides).forEach(function(lang){
        if (!introByForm[lang]) introByForm[lang] = {};
        var src = window.introByFormOverrides[lang] || {};
        Object.keys(src).forEach(function(formId){
          introByForm[lang][formId] = src[formId];
        });
      });
    }
  }catch(_){}

  // messagesInterface overrides (merge)
  try{
    if (window.messagesInterfaceOverrides && window.messagesInterface){
      Object.keys(window.messagesInterfaceOverrides).forEach(function(lang){
        var src = window.messagesInterfaceOverrides[lang] || {};
        if (!messagesInterface[lang]) messagesInterface[lang] = {};
        Object.keys(src).forEach(function(k){
          messagesInterface[lang][k] = src[k];
        });
      });
    }
  }catch(_){}
});
</script>


<!-- HARD-STOP language guard: blocks immediately if chosen language is not Svenska -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    var btn = document.getElementById('nextLangBtn');
    if (!btn) return;
    // Capture-phase so we run BEFORE any other click handlers
    btn.addEventListener('click', function(ev){
      try{
        var ls = document.getElementById('langSelect');
        var chosen = (ls && ls.value) ? ls.value : 'Svenska';
        if (chosen !== 'Svenska'){
          var el = document.getElementById('menuError');
          var word = (chosen==='English' ? 'Language' : chosen==='Svenska' ? 'SprÃ¥k' : 'Langue');
          var na   = (chosen==='English' ? 'Unavailable' : chosen==='Svenska' ? 'Ej tillgÃ¤nglig' : 'Non disponible');
          if (el) el.textContent = word + ' : ' + na + ' (endast: Svenska)';
          try { if (typeof jouerBipErreur==='function') jouerBipErreur(); } catch(_){}
          ev.stopImmediatePropagation(); // stop other handlers
          ev.preventDefault();
          return false;
        }
      }catch(_){}
      return true;
    }, true); // <-- CAPTURE
  }catch(_){}
});
</script>

<script>
(function(){
  function getLang(){
    try { return window.currentLang || (document.documentElement.getAttribute('lang')==='sv'?'Svenska':'FranÃ§ais'); }
    catch(_){ return 'FranÃ§ais'; }
  }
  function invalidMsgFor(lang){
    if (lang==='English') return 'Rewrite your answer';
    if (lang==='Svenska') return 'Skriv om ditt svar';
    return 'RÃ©Ã©crivez votre rÃ©ponse';
  }

  // Essaie de localiser le champ "Ange ditt svar"
  function findScoreInput(){
    // 1) ID habituel
    var el = document.getElementById('scoreInput');
    if (el) return el;
    // 2) Chercher le label contenant "Ange ditt svar"
    var labels = document.querySelectorAll('label, .label, span, p, div');
    for (var i=0;i<labels.length;i++){
      var t = (labels[i].innerText||labels[i].textContent||'').trim().toLowerCase();
      if (t.includes('ange ditt svar')){
        // champ immÃ©diatement aprÃ¨s ou dans le mÃªme conteneur
        var next = labels[i].nextElementSibling;
        if (next && next.tagName==='INPUT') return next;
        var input = labels[i].parentElement && labels[i].parentElement.querySelector('input');
        if (input) return input;
      }
    }
    // 3) fallback: un input number bornÃ© 1â€“5 visible
    var cand = document.querySelector('input[type="number"][min="1"][max="5"]');
    if (cand) return cand;
    // 4) dernier recours: premier input visible
    return document.querySelector('input');
  }

  function ensureErrorBelow(input){
    var el = document.getElementById('scoreError');
    if (!el){
      el = document.createElement('div');
      el.id = 'scoreError';
      el.style.cssText = 'color:blue;font-weight:bold;margin-top:4px;display:block;';
      input.insertAdjacentElement('afterend', el);
    }
    return el;
  }

  function showInvalid(){
    var input = findScoreInput(); if(!input) return;
    var msg = invalidMsgFor(getLang());
    var el = ensureErrorBelow(input);
    el.textContent = msg;
    try { if (typeof jouerBipErreur==='function') jouerBipErreur(); } catch(_){}
  }

  function clearInvalid(){
    var el = document.getElementById('scoreError');
    if(el) el.textContent = '';
  }

  function validateVal(v){
    var n = parseInt(v,10);
    if (isNaN(n) || n<1 || n>5){ showInvalid(); return false; }
    clearInvalid(); return true;
  }

  function attach(){
    var si = findScoreInput();
    if(!si || si.__hasValidation) return;
    si.__hasValidation = true;
    si.addEventListener('blur',   function(){ validateVal(this.value); });
    si.addEventListener('change', function(){ validateVal(this.value); });
    si.addEventListener('keydown',function(e){ if(e.key==='Enter'){ validateVal(this.value); }});
    // Bloquer la navigation si invalide
    var btn = document.getElementById('nextLangBtn') || document.getElementById('nextBtn') || document.querySelector('button[type="submit"]');
    if (btn && !btn.__scoreGuard){
      btn.__scoreGuard = true;
      btn.addEventListener('click', function(ev){
        var s = findScoreInput();
        if (s && s.offsetParent!==null && !validateVal(s.value)){
          ev.preventDefault(); ev.stopImmediatePropagation();
          return false;
        }
        return true;
      }, true); // capture
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attach);
  } else {
    attach();
  }
  // Si le champ apparaÃ®t plus tard (changement de page), on rÃ©-attache
  var obs = new MutationObserver(attach);
  try { obs.observe(document.documentElement, {childList:true, subtree:true}); } catch(_){}
})();
</script>





<!-- BEGIN NOTABLE_SCORE_GUARD (bleu, effacement aprÃ¨s affichage, focus, 1â€“5, flÃ¨ches neutralisÃ©es) -->
<script>
(function(){
  function getLang(){
    try { return window.currentLang || (document.documentElement.getAttribute('lang')==='sv'?'Svenska':'FranÃ§ais'); }
    catch(_){ return 'FranÃ§ais'; }
  }
  function invalidMsgFor(lang){
    if (lang==='English') return 'Rewrite your answer';
    if (lang==='Svenska') return 'Skriv om ditt svar';
    return 'RÃ©Ã©crivez votre rÃ©ponse';
  }
  function findScoreInput(){
    var el = document.getElementById('scoreInput'); if (el) return el;
    var q = document.querySelector('input[type="number"][min], input[type="number"], input[name*="score" i], input[data-score], input[aria-label*="Ange ditt svar" i]');
    if (q) return q;
    var all = document.querySelectorAll('input');
    for (var i=0;i<all.length;i++){
      var n = all[i], s = window.getComputedStyle(n);
      if (s.display!=='none' && s.visibility!=='hidden' && n.offsetParent!==null) return n;
    }
    return null;
  }
  function ensureErrorBelow(input){
    var el = document.getElementById('scoreError');
    if (!el){
      el = document.createElement('div');
      el.id = 'scoreError';
      el.style.cssText = 'color:blue;font-weight:bold;margin-top:4px;display:block;';
      input.insertAdjacentElement('afterend', el);
    } else {
      el.style.display = 'block';
    }
    return el;
  }
  function forceFocus(input){
    try { input.blur(); } catch(_){}
    setTimeout(function(){
      try { input.focus({preventScroll:true}); } catch(_){ try{ input.focus(); }catch(e){} }
      try { input.setSelectionRange(0,0); } catch(_){}
    }, 0);
  }
  function showInvalid(input){
    var el = ensureErrorBelow(input);
    el.textContent = invalidMsgFor(getLang());     // 1) montrer le message d'abord
    try { if (typeof jouerBipErreur==='function') jouerBipErreur(); } catch(_){}
    try { input.value = ''; } catch(_){}
    try { input.dispatchEvent(new Event('input', {bubbles:true})); } catch(_){}
    try { input.dispatchEvent(new Event('change', {bubbles:true})); } catch(_){}
    forceFocus(input);
  }
  function clearInvalid(){
    var el = document.getElementById('scoreError');
    if (el) el.textContent = '';
  }
  function validateVal(input){
    var n = parseInt(input.value,10);
    if (isNaN(n) || n<1 || n>5){ showInvalid(input); return false; }
    clearInvalid(); return true;
  }
  function attach(){
    var si = findScoreInput();
    if (!si || si.__hasValidationGuard) return;
    try { si.min = 1; si.max = 5; } catch(_){}
    try {
      si.style.MozAppearance = "textfield";
      si.style.appearance = "textfield";
      si.addEventListener('wheel', function(e){ e.preventDefault(); }, {passive:false});
      si.addEventListener('keydown', function(e){
        if (e.key==='ArrowUp' || e.key==='ArrowDown'){
          var v = parseInt(this.value||'',10);
          if (isNaN(v) || v<1 || v>5) e.preventDefault();
        }
      });
      var css = document.createElement("style");
      css.textContent = 'input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0;}';
      document.head.appendChild(css);
    } catch(_){}
    si.addEventListener('input', function(){
      var v = this.value, n = parseInt(v,10);
      if (v!=='' && (isNaN(n) || n<1 || n>5)) showInvalid(this);
    });
    si.addEventListener('blur',   function(){ validateVal(this); });
    si.addEventListener('change', function(){ validateVal(this); });
    si.addEventListener('keydown',function(e){
      if(e.key==='Enter'){ if(!validateVal(this)){ e.preventDefault(); e.stopPropagation(); } }
    });
    var btn = document.getElementById('nextLangBtn') || document.getElementById('nextBtn') || document.querySelector('button[type="submit"]');
    if (btn && !btn.__scoreGuard){
      btn.__scoreGuard = true;
      btn.addEventListener('click', function(ev){
        var s = findScoreInput();
        if (s && s.offsetParent!==null){
          if (!validateVal(s)){ ev.preventDefault(); ev.stopImmediatePropagation(); return false; }
        }
        return true;
      }, true);
    }
    si.__hasValidationGuard = true;
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attach);
  } else {
    attach();
  }
  try { new MutationObserver(attach).observe(document.documentElement,{childList:true,subtree:true}); } catch(_){}
})();
</script>
<!-- END NOTABLE_SCORE_GUARD -->

<script>
// === Dynamic loader for CodicentJS with fallback & diagnostics ===
async function loadCodicentJS(){
  if (window.Codicent && window.Codicent.postMessage) return true;
  return new Promise((resolve)=>{
    const statusDiv = document.getElementById('codicentStatus');
    function say(msg, color){ if(statusDiv){ statusDiv.style.display='block'; statusDiv.style.color=color||'red'; statusDiv.textContent=msg; } }
    const s = document.createElement('script');
    s.src = "https://izaxon.github.io/codicentjs/codicentjs.min.js";
    s.async = true;
    s.onload = ()=>{ resolve(!!(window.Codicent && window.Codicent.postMessage)); };
    s.onerror = ()=>{ say("CodicentJS could not be loaded from izaxon.github.io. If blocked, please use local copy.", "red"); resolve(false); };
    document.head.appendChild(s);
    setTimeout(()=>{ if (!(window.Codicent && window.Codicent.postMessage)){ say("Loading CodicentJS is taking too long... (network blocked?)", "orange"); } }, 3000);
  });
}

// Helper: Blob â†’ Base64
function blobToBase64(blob){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      const res = reader.result || "";
      const b64 = String(res).includes(",") ? String(res).split(",")[1] : String(res);
      resolve(b64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// CLICK HANDLER: build PDF and send to Codicent
document.getElementById("sendToCodicentBtn")?.addEventListener('click', async () => {
  const statusDiv = document.getElementById('codicentStatus');
  try {
    const ok = await loadCodicentJS();
    if (!ok) throw new Error('CodicentJS not loaded');

    const params = new URLSearchParams(window.location.search);
    const token  = params.get('token') || localStorage.getItem('access_token');
    if (!token) {
      statusDiv.style.color = 'red';
      statusDiv.textContent = 'No ?token=â€¦ parameter found in the URL.';
      statusDiv.style.display = 'block';
      setTimeout(()=> statusDiv.style.display='none', 6000);
      return;
    }

    if (!window.jspdf || !window.jspdf.jsPDF) throw new Error('jsPDF not available (include it in <head>).');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    // === Remplis le PDF avec tes vraies donnÃ©es ===
    let y = 10;
    pdf.setFontSize(14); pdf.text("Questionnaire â€“ Summary", 10, y); y += 8;
    pdf.setFontSize(11);

    const code = (document.getElementById('codeInput')?.value || window.userCode || "").trim();
    if (code){ pdf.text("Code: " + code, 10, y); y += 6; }

    if (Array.isArray(window.questions) && Array.isArray(window.answers)){
      window.questions.forEach((q, i) => {
        const qText = (q && (q.text || q.texte || "")) ? String(q.text || q.texte) : "";
        const aText = (window.answers[i] || "");
        const block = (i+1) + ". " + qText + "\nSvar: " + aText;
        const lines = pdf.splitTextToSize(block, 180);
        if (y + lines.length * 6 > 285) { pdf.addPage(); y = 10; }
        pdf.text(lines, 10, y);
        y += lines.length * 6 + 2;
      });
    }

    const globalComment = (document.getElementById('globalComment')?.value || "").trim();
    if (globalComment){
      const lines = pdf.splitTextToSize("Kommentar: " + globalComment, 180);
      if (y + lines.length * 6 > 285) { pdf.addPage(); y = 10; }
      pdf.text(lines, 10, y); y += lines.length * 6 + 2;
    }

    const pdfBlob = pdf.output("blob");
    const pdfBase64 = await blobToBase64(pdfBlob);

    window.Codicent.init({ token, maxConnectionAttempts: 3 });
    const messageId = await window.Codicent.postMessage({
      message: {
        filename: "questionnaire.pdf",
        filetype: "application/pdf",
        content: pdfBase64
      }
    });

    statusDiv.style.color='green';
    statusDiv.textContent = 'PDF sent to Codicent! ID: ' + messageId;
    statusDiv.style.display='block';
    setTimeout(()=> statusDiv.style.display='none', 8000);

  } catch (e) {
    statusDiv.style.color='red';
    statusDiv.textContent = 'Error sending to Codicent: ' + (e?.message || e);
    statusDiv.style.display='block';
    setTimeout(()=> statusDiv.style.display='none', 8000);
  }
});
</script>

<script>
// MODIF ajustement des langues â€” fin de rÃ©ponse robuste (STOP/SLUT/SLUTA) sans toucher Ã  tes fonctions
(function(){
  // Normalisation (minuscules, accents retirÃ©s, ponctuation enlevÃ©e)
  function norm(s){
    if (typeof s !== "string") return "";
    s = s.toLowerCase().trim();
    if (s.normalize) s = s.normalize("NFKD").replace(/[\u0300-\u036f]/g,"");
    return s.replace(/[.,!?;:()\[\]{}"Â«Â»â€¦]/g," ").replace(/\s+/g," ").trim();
  }

  // On accepte ces mots-clÃ©s (pour fiabiliser la reco Edge: "slut." / "sluta.")
  function hasEndWord(s){
    const n = norm(s);
    // si tu veux strictement par langue, remets le test sur window.currentLang ici
    return /\b(stop|slut|sluta)\b/i.test(n);
  }
  function stripEndWord(s){
    let n = norm(s);
    n = n.replace(/\b(stop|slut|sluta)\b/gi,"").replace(/\s+/g," ").trim();
    return n;
  }

  // Trouver le champ de rÃ©ponse "actif" (input texte ou textarea visible)
  function getActiveAnswerEl(){
    const cand = Array.from(document.querySelectorAll('textarea, input[type="text"], input:not([type])'));
    const vis = cand.filter(el => el && el.offsetParent !== null && !el.disabled && !el.readOnly);
    if (document.activeElement && vis.includes(document.activeElement)) return document.activeElement;
    // fallback: le plus large (souvent le champ principal)
    return vis.sort((a,b)=> (b.clientWidth*b.clientHeight) - (a.clientWidth*a.clientHeight))[0] || null;
  }

  // Nettoie + valide (aprÃ¨s que ton code a Ã©crit dans le champ)
  function cleanAndValidateNow(el){
    if (!el) return;
    const raw = el.value;
    if (!raw) return;
    if (!hasEndWord(raw)) return;
    const cleaned = stripEndWord(raw);
    setTimeout(function(){
      const e = getActiveAnswerEl() || el;
      if (e) e.value = cleaned;
      if (typeof validateAnswer === "function") validateAnswer();
    }, 0);
  }

  // Ã‰coute tous les changements dâ€™entrÃ©e (clavier, reco, etc.)
  document.addEventListener('input', function(ev){
    const t = ev && ev.target;
    if (!t) return;
    if (t.matches('textarea, input[type="text"], input:not([type])')){
      // laisse d'abord les autres handlers finir, puis on agit
      setTimeout(()=> cleanAndValidateNow(t), 0);
    }
  }, true);

  // SÃ©curitÃ© : si ton code met Ã  jour sans dÃ©clencher 'input', on scrute les variations
  let lastVal = "";
  setInterval(function(){
    const el = getActiveAnswerEl();
    if (!el) return;
    const v = el.value;
    if (v !== lastVal){
      lastVal = v;
      setTimeout(()=> cleanAndValidateNow(el), 0);
    }
  }, 200);
})();
</script>
<script>
// MODIF â€” focus automatique aprÃ¨s clic sur TYST/RÃ–ST et MICRO (additif, sans override)
(function(){
  // DÃ©finir focusAnswer uniquement si elle n'existe pas dÃ©jÃ 
  if (typeof window.focusAnswer !== "function"){
    window.focusAnswer = function(){
      try{
        var a = document.getElementById("answerInput");
        if (!a) return;
        a.focus();
        // place le curseur Ã  la fin
        var v = a.value || "";
        try{ a.setSelectionRange(v.length, v.length); }catch(_){}
      }catch(_){}
    };
  }

  function attachFocusAfterClick(el){
    if (!el) return;
    // On n'empÃªche rien : on se contente d'ajouter un listener APRES ton handler
    el.addEventListener("click", function(){
      // Laisse d'abord le bouton faire son toggle, puis remet le focus
      setTimeout(window.focusAnswer, 0);
    }, false);
  }

  // Boutons connus par id
  attachFocusAfterClick(document.getElementById("ttsToggleBtn")); // TYST/RÃ–ST
  attachFocusAfterClick(document.getElementById("voiceBtn"));     // MICRO

  // Filet de sÃ©curitÃ© : si les IDs changent, on tente sur les boutons dont le texte contient TYST/RÃ–ST/VOICE/MICRO
  var candidates = Array.from(document.querySelectorAll('button, [role="button"]'))
    .filter(function(b){
      var t = (b.textContent || "").toLowerCase();
      return /tyst|rÃ¶st|rost|voice|micro|mikro/i.test(t);
    });
  candidates.forEach(attachFocusAfterClick);
})();
</script>


<script>

/* ===== TTS â€” bloc unique (PC / Samsung) ===== */
/* IMPORTANT: garde UNE SEULE fois cette dÃ©claration dans tout le fichier */
var synth = window.speechSynthesis || null;

var __voices = [];
var TTS_STORE_KEY = "ttsVoiceNameByLangCode";
var ttsVoiceNameByLang = {};

// 1) Map currentLang -> BCP-47
function getCurrentLangCode(){
  var txt = (window.currentLang || "").toLowerCase();
  if (txt.indexOf("sv")===0) return "sv-SE";
  if (txt.indexOf("en")===0) return "en-US";
  if (txt.indexOf("fr")===0) return "fr-FR";
  return "fr-FR";
}

// 2) Store
(function(){
  try{ ttsVoiceNameByLang = JSON.parse(localStorage.getItem(TTS_STORE_KEY) || "{}"); }
  catch(_){ ttsVoiceNameByLang = {}; }
})();
function tts_saveStore(){ try{ localStorage.setItem(TTS_STORE_KEY, JSON.stringify(ttsVoiceNameByLang)); }catch(_){} }

// 3) Candidates
function tts_candidatesForLang(langCode){
  var want = langCode.indexOf("sv")===0 ? ["sv-SE","sv"]
           : langCode.indexOf("en")===0 ? ["en-US","en-GB","en"]
           :                               ["fr-FR","fr-CA","fr"];
  var low = function(s){ return (s||"").toLowerCase(); };
  var vendorsFirst = function(v){ return /google|microsoft|samsung|apple/i.test(v.name); };

  var exact = (__voices||[]).filter(function(v){ return want.indexOf(v.lang)>=0 || want.indexOf((v.lang||"").substr(0,5))>=0; });
  var langOnly = (__voices||[]).filter(function(v){
    return exact.indexOf(v)===-1 && want.some(function(w){ return low(v.lang).indexOf(low(w.substring(0,2)))===0; });
  });
  return exact.concat(langOnly).sort(function(a,b){ return (vendorsFirst(b)-vendorsFirst(a)); });
}

// 4) UI strings
function tts_uiStrings(){
  var code = getCurrentLangCode();
  if (code.indexOf("sv")===0){
    return {
      label:"RÃ¶st (enligt enheten):",
      test:"RÃ¶sttest",
      hint:"Valet sparas per sprÃ¥k. AnvÃ¤nd â€RÃ¶sttestâ€.",
      noVoice:function(lc){ return "Ingen lokal rÃ¶st tillgÃ¤nglig fÃ¶r " + lc + ". Installera rÃ¶sten i Android/Windows."; }
    };
  }
  if (code.indexOf("en")===0){
    return {
      label:"Voice (device):",
      test:"Test voice",
      hint:"Choice saved per language. Use â€œTest voiceâ€.",
      noVoice:function(lc){ return "No local voice available for " + lc + ". Install the voice in Android/Windows."; }
    };
  }
  return {
    label:"Voix (selon l'appareil) :",
    test:"Test voix",
    hint:"Choix mÃ©morisÃ© par langue. Utilise Â« Test voix Â».",
    noVoice:function(lc){ return "Aucune voix locale disponible pour " + lc + ". Installe la voix dans Android/Windows."; }
  };
}
function tts_applyUILabels(){
  var s = tts_uiStrings();

  // Trouve le label de maniÃ¨re robuste (plusieurs fallback)
  var lab = document.getElementById("voiceLabel");
  if (!lab) {
    lab = document.querySelector('label[for="voiceSelect"]');
    if (!lab) {
      var sel = document.getElementById("voiceSelect");
      // remonte jusqu'au conteneur #voiceRow puis cherche le 1er label
      var n = sel;
      while (n && n.id !== "voiceRow") n = n.parentNode;
      if (n) lab = n.querySelector("label");
    }
  }

  var btn  = document.getElementById("testVoiceBtn");
  var hint = document.getElementById("voiceHint");

  if (lab)  lab.textContent  = s.label;   // ex: "RÃ¶st (enligt enheten):"
  if (btn)  btn.textContent  = s.test;    // ex: "RÃ¶sttest"
  if (hint) hint.textContent = s.hint;    // ex: "Valet sparas per sprÃ¥kâ€¦"
}




// 5) Populate select
function tts_populateVoiceSelect(){
  var sel  = document.getElementById("voiceSelect");
  var hint = document.getElementById("voiceHint");
  if (!sel) return;

  sel.innerHTML = "";
  var langCode = getCurrentLangCode();
  var list = tts_candidatesForLang(langCode);
  var key = langCode.substring(0,2).toUpperCase(); // SV/FR/EN
  var stored = ttsVoiceNameByLang[key];
  var ui = tts_uiStrings();

  if (!list.length){
    var o = document.createElement("option");
    o.value = ""; o.textContent = ui.noVoice(langCode);
    sel.appendChild(o);
    if (hint) hint.textContent = ui.noVoice(langCode);
    tts_applyUILabels();
    return;
  }

  list.forEach(function(v){
    var o = document.createElement("option");
    o.value = v.name; o.textContent = v.name + " (" + v.lang + ")";
    sel.appendChild(o);
  });

  if (stored && list.find(function(v){ return v.name===stored; })) {
    sel.value = stored;
  } else {
    sel.selectedIndex = 0;
  }
  tts_applyUILabels();
}

// 6) Selected voice
function tts_getSelectedVoice(){
  var sel = document.getElementById("voiceSelect");
  var name = sel && sel.value;
  return name ? (__voices||[]).find(function(v){ return v.name===name; }) || null : null;
}

// 7) Load voices
function tts_loadVoices(){
  try{ __voices = synth ? (synth.getVoices() || []) : []; }catch(_){ __voices = []; }
  tts_populateVoiceSelect();
}
if (typeof speechSynthesis !== "undefined"){
  speechSynthesis.onvoiceschanged = tts_loadVoices;
  setTimeout(tts_loadVoices, 0);
  setTimeout(tts_loadVoices, 600);
}

// 8) Wire UI + sync with existing language menu (#langSelect)
document.addEventListener("DOMContentLoaded", function(){
  var langSel = document.getElementById("langSelect");
  if (langSel){
    window.currentLang = langSel.value || (langSel.options[langSel.selectedIndex] && langSel.options[langSel.selectedIndex].text) || window.currentLang || "FranÃ§ais";
    onUILanguageChanged();
    langSel.addEventListener("change", function(){
      window.currentLang = langSel.value || (langSel.options[langSel.selectedIndex] && langSel.options[langSel.selectedIndex].text) || "FranÃ§ais";
      onUILanguageChanged();
    });
  } else {
    window.currentLang = window.currentLang || "FranÃ§ais";
  }

  var sel = document.getElementById("voiceSelect");
  if (sel){
    sel.addEventListener("change", function(){
      var key = getCurrentLangCode().substring(0,2).toUpperCase();
      ttsVoiceNameByLang[key] = sel.value || "";
      tts_saveStore();
    });
  }

  var testBtn = document.getElementById("testVoiceBtn");
  if (testBtn){
    testBtn.addEventListener("click", function(){
      var code = getCurrentLangCode();
      var sample = code.indexOf("sv")===0 ? "Det hÃ¤r Ã¤r ett rÃ¶sttest."
                 : code.indexOf("en")===0 ? "This is a voice test."
                 : "Ceci est un test de voix.";
      tts_testSpeak(sample);
    });
  }

  tts_loadVoices();
  tts_applyUILabels();
});

// 9) Test voice
function tts_testSpeak(text){
  if (!synth || !text) return;
  try{
    var u = new SpeechSynthesisUtterance(text);
    u.lang = getCurrentLangCode();
    var v = tts_getSelectedVoice(); if (v) u.voice = v;
    u.rate = 1.0; u.pitch = 1.0;
    synth.cancel(); synth.speak(u);
  }catch(_){}
}

// 10) Call when UI language changed (and at end of updateInterfaceLang)
function onUILanguageChanged(){
  try { 
    tts_populateVoiceSelect();
    tts_applyUILabels();
  } catch(_) {}
}

// 11) Unified speak
function lireTexte(txt){
  if (!window.ttsEnabled || !txt || !synth) return;
  if (!__voices || __voices.length === 0){ setTimeout(function(){ lireTexte(txt); }, 350); return; }
  try{
    var plain = String(txt).replace(/<[^>]+>/g,"");
    var u = new SpeechSynthesisUtterance(plain);
    u.lang = getCurrentLangCode();
    var v = tts_getSelectedVoice(); if (v) u.voice = v;
    u.rate = 1.0; u.pitch = 1.0;
    synth.cancel(); synth.speak(u);
  }catch(_){}
}

</script>

<script>
(function(){
  if (!('speechSynthesis' in window)) return;
  if (window.__speakGuardLight) return;
  window.__speakGuardLight = true;
  var _speak = speechSynthesis.speak.bind(speechSynthesis);
  speechSynthesis.speak = function(u){
    try { if (typeof window.ttsEnabled !== 'undefined' && !window.ttsEnabled) return; } catch(_){}
    _speak(u);
  };
})();
</script>

</body>
</html>
